

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DUTs &mdash; pcdshub/lcls-twincat-common-components  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/tree.css?v=837a00b9" />
      <link rel="stylesheet" type="text/css" href="_static/width.css?v=ab210c7a" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9a2dae69"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="_static/docs-versions-menu.js?v=3d6a1aea"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Data Types" href="lcls-twincat-common-components_Library_epics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            pcdshub/lcls-twincat-common-components
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">lcls-twincat-common-components</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_pragmas.html">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_nc.html">NC Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_ethercat.html">EtherCAT Terminals</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_boxes.html">Boxes</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_links.html">Links</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Library</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_summary.html">Settings</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_summary.html#pragmas">Pragmas</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_summary.html#libraries">Libraries</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_summary.html#symbols">Symbols</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_epics.html">Data Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="lcls-twincat-common-components_Library_epics.html#database-records">Database Records</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DUTs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#e-atm-states">E_ATM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-lic-states">E_LIC_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-ppm-states">E_PPM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-sxr-satt-position">E_SXR_SATT_Position</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-wfs-states">E_WFS_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-xpim-filters">E_XPIM_Filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="#e-xpim-states">E_XPIM_States</a></li>
<li class="toctree-l2"><a class="reference internal" href="#st-satt-filter">ST_SATT_Filter</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#gvls">GVLs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#global-version">Global_Version</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="#pous">POUs</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#fb-atm">FB_ATM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-atmtest">FB_ATMTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-attenuatorelementdensity">FB_AttenuatorElementDensity</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-cc-tempsensortest">FB_CC_TempSensorTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-checkpositionstatewritetest">FB_CheckPositionStateWriteTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-fdq-flowmeter">FB_FDQ_FlowMeter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lic">FB_LIC</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-lictest">FB_LICTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ppm">FB_PPM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ppm-gige">FB_PPM_Gige</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ppm-powermeter">FB_PPM_PowerMeter</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ppmtest">FB_PPMTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ref">FB_REF</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-ref-laser">FB_REF_Laser</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-reftest">FB_REFTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-satttest">FB_SATTTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-slits">FB_SLITS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-slits-power">FB_SLITS_POWER</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-slits-powertest">FB_SLITS_POWERTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-sxr-satt-stage">FB_SXR_SATT_Stage</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-wfs">FB_WFS</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-wfstest">FB_WFSTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xpim">FB_XPIM</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xpim-filterwheel">FB_XPIM_FilterWheel</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xpim-led">FB_XPIM_LED</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xpim-opal">FB_XPIM_Opal</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xpimtest">FB_XPIMTest</a></li>
<li class="toctree-l2"><a class="reference internal" href="#fb-xtes-flowswitch">FB_XTES_Flowswitch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#prg-test">PRG_TEST</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">pcdshub/lcls-twincat-common-components</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DUTs</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/lcls-twincat-common-components_Library_source.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="duts">
<h1>DUTs<a class="headerlink" href="#duts" title="Link to this heading"></a></h1>
<section id="e-atm-states">
<h2>E_ATM_States<a class="headerlink" href="#e-atm-states" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_ATM_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TARGET1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">TARGET2</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">TARGET3</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">TARGET4</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">TARGET5</span> <span class="o">:=</span> <span class="mi">6</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-atm-states">E_ATM_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="e-lic-states">
<h2>E_LIC_States<a class="headerlink" href="#e-lic-states" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_LIC_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">MIRROR1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">MIRROR2</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">TARGET</span> <span class="o">:=</span> <span class="mi">4</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-ppm-states">
<h2>E_PPM_States<a class="headerlink" href="#e-ppm-states" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_PPM_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">POWERMETER</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">YAG1</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">YAG2</span> <span class="o">:=</span> <span class="mi">4</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-sxr-satt-position">
<h2>E_SXR_SATT_Position<a class="headerlink" href="#e-sxr-satt-position" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_SXR_SATT_Position</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">UNKNOWN</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">//</span> <span class="n">UNKNOWN</span> <span class="n">must</span> <span class="n">be</span> <span class="ow">in</span> <span class="n">slot</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">the</span> <span class="n">FB</span> <span class="n">breaks</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span> <span class="o">//</span> <span class="n">OUT</span> <span class="n">at</span> <span class="n">slot</span> <span class="mi">1</span> <span class="ow">is</span> <span class="n">a</span> <span class="n">convention</span>
    <span class="n">FILTER1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">FILTER2</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">FILTER3</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">FILTER4</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">FILTER5</span> <span class="o">:=</span> <span class="mi">6</span><span class="p">,</span>
    <span class="n">FILTER6</span> <span class="o">:=</span> <span class="mi">7</span><span class="p">,</span>
    <span class="n">FILTER7</span> <span class="o">:=</span> <span class="mi">8</span><span class="p">,</span>
    <span class="n">FILTER8</span> <span class="o">:=</span> <span class="mi">9</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-wfs-states">
<h2>E_WFS_States<a class="headerlink" href="#e-wfs-states" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_WFS_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">TARGET1</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">TARGET2</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">TARGET3</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">TARGET4</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">TARGET5</span> <span class="o">:=</span> <span class="mi">6</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-xpim-filters">
<h2>E_XPIM_Filters<a class="headerlink" href="#e-xpim-filters" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_XPIM_Filters</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">T50</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">T25</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">T10</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">T5</span> <span class="o">:=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="n">T1</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">,</span>
    <span class="n">T100</span> <span class="o">:=</span> <span class="mi">6</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="e-xpim-states">
<h2>E_XPIM_States<a class="headerlink" href="#e-xpim-states" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;qualified_only&#39;</span><span class="p">}</span>
<span class="n">TYPE</span> <span class="n">E_XPIM_States</span> <span class="p">:</span>
<span class="p">(</span>
    <span class="n">Unknown</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">OUT</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">YAG</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="n">DIAMOND</span> <span class="o">:=</span> <span class="mi">3</span><span class="p">,</span>
    <span class="n">RETICLE</span> <span class="o">:=</span> <span class="mi">4</span>
<span class="p">)</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
<section id="st-satt-filter">
<h2>ST_SATT_Filter<a class="headerlink" href="#st-satt-filter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TYPE</span> <span class="n">ST_SATT_Filter</span> <span class="p">:</span>
<span class="n">STRUCT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MATERIAL</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Filter</span> <span class="n">material</span> <span class="n">name</span>
    <span class="s1">&#39;}</span>
    <span class="n">sFilterMaterial</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">THICKNESS</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">DESC</span> <span class="n">Filter</span> <span class="n">material</span> <span class="n">thickness</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">um</span>
    <span class="s1">&#39;}</span>
    <span class="n">fFilterThickness_um</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_STRUCT</span>
<span class="n">END_TYPE</span>
</pre></div>
</div>
</section>
</section>
<section id="gvls">
<h1>GVLs<a class="headerlink" href="#gvls" title="Link to this heading"></a></h1>
<section id="global-version">
<h2>Global_Version<a class="headerlink" href="#global-version" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;TcGenerated&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;no-analysis&#39;</span><span class="p">}</span>
<span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;linkalways&#39;</span><span class="p">}</span>
<span class="o">//</span> <span class="n">This</span> <span class="n">function</span> <span class="n">has</span> <span class="n">been</span> <span class="n">automatically</span> <span class="n">generated</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">project</span> <span class="n">information</span><span class="o">.</span>
<span class="n">VAR_GLOBAL</span> <span class="n">CONSTANT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;const_non_replaced&#39;</span><span class="p">}</span>
    <span class="n">stLibVersion_lcls_twincat_common_components</span> <span class="p">:</span> <span class="n">ST_LibVersion</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iMajor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iMinor</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iBuild</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">iRevision</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nFlags</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sVersion</span> <span class="o">:=</span> <span class="s1">&#39;0.0.0&#39;</span><span class="p">);</span>
<span class="n">END_VAR</span>
</pre></div>
</div>
</section>
</section>
<section id="pous">
<h1>POUs<a class="headerlink" href="#pous" title="Link to this heading"></a></h1>
<section id="fb-atm">
<h2>FB_ATM<a class="headerlink" href="#fb-atm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_ATM</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">Arrival</span> <span class="n">Time</span> <span class="n">Monitor</span> <span class="p">(</span><span class="n">ATM</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">target</span> <span class="n">states</span>
    <span class="o">-</span> <span class="n">thermocouple</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">X</span> <span class="n">motor</span> <span class="p">(</span><span class="n">align</span> <span class="n">target</span> <span class="n">to</span> <span class="n">beam</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stXStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET1</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET2</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET3</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget3</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET4</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget4</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET5</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget5</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_ATM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_ATM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbXStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..6</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STC:01&#39;</span><span class="p">}</span>
    <span class="n">fbTempSensor1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span><span class="s1">&#39;pv: FWM&#39;</span><span class="p">}</span>
    <span class="n">fbFlowMeter</span><span class="p">:</span> <span class="n">FB_AnalogInput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">60</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">State</span> <span class="n">defaults</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">provided</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">fOutDecel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stXStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fOutDecel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget1</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET1&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget2</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET2&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget3</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET3&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget4</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET4&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget5</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET5&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">stXStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stXStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stXStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stXStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>
<span class="n">fbXStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stXStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget1</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget2</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget3</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET4</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget4</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET5</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget5</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stTarget1</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">];</span>
<span class="n">stTarget2</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">];</span>
<span class="n">stTarget3</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET3</span><span class="p">];</span>
<span class="n">stTarget4</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET4</span><span class="p">];</span>
<span class="n">stTarget5</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_ATM_States</span><span class="o">.</span><span class="n">TARGET5</span><span class="p">];</span>

<span class="n">fbTempSensor1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">fbStates</span><span class="o">.</span><span class="n">stDbStateParams</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">bVeto</span><span class="o">:=</span><span class="n">eEnumGet</span> <span class="o">=</span> <span class="n">E_ATM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFlowMeter</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-atm-states">E_ATM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-atmtest">
<h2>FB_ATMTest<a class="headerlink" href="#fb-atmtest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_ATMTest EXTENDS FB_TestSuite
VAR
    fbATM: FB_ATM;
    stYStage: ST_MotionStage;
    stXStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbATM.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbATM.stTarget1, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbATM.stTarget2, sName:=&#39;T2&#39;, fPosition:=30, sPmpsState:=&#39;T2&#39;);
fbSetup(stPositionState:=fbATM.stTarget3, sName:=&#39;T3&#39;, fPosition:=40, sPmpsState:=&#39;T3&#39;);
fbSetup(stPositionState:=fbATM.stTarget4, sName:=&#39;T4&#39;, fPosition:=50, sPmpsState:=&#39;T4&#39;);
fbSetup(stPositionState:=fbATM.stTarget5, sName:=&#39;T5&#39;, fPosition:=60, sPmpsState:=&#39;T5&#39;);

// Standard FB call
fbATM(
    stYStage:=stYStage,
    stXStage:=stXStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();
TestTempFFO();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD SetATMTemp
VAR_INPUT
    iTempC: INT;
END_VAR
VAR
    ptr: POINTER TO INT;
END_VAR
ptr := ADR(fbATM.fbTempSensor1.iRaw);
ptr^ := iTempC * 10;
END_METHOD

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_ATM_States.TARGET5;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestATMStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbATM.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbATM.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in ATM move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestTempFFO
VAR_INST
    tonTimer: TON;
    nStep: UINT := 0;
    bOutChecked: BOOL := FALSE;
    bInChecked: BOOL := FALSE;
END_VAR
VAR CONSTANT
    nLastStep: UINT := 3;
END_VAR
// Do we fault at the correct times?
// Parasitically depends on state move test
TEST(&#39;TestATMTempFFO&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

CASE nStep OF
    0:
        // Set the thermocouple temperatures to crazy high number
        SetATMTemp(100);
        nStep := nStep + 1;
    1:
        // Wait till we see &quot;OUT&quot; state and one other state (OUT should be no fault)
        IF fbATM.eEnumGet = E_ATM_States.OUT THEN
            AssertTrue(
                fbATM.fbTempSensor1.FFO.i_xOK,
                &#39;Faulted even in out position!&#39;,
            );
            bOutChecked := TRUE;
        ELSIF fbATM.eEnumGet &lt;&gt; E_ATM_States.Unknown THEN
            AssertFalse(
                fbATM.fbTempSensor1.FFO.i_xOK,
                &#39;No fault even for an in position!&#39;,
            );
            bInChecked := TRUE;
        END_IF
        IF bOutChecked AND bInChecked THEN
            nStep := nStep + 1;
        END_IF
    2:
        // Set the thermocouple temperatures to low again
        SetATMTemp(0);
        nStep := nStep + 1;
    3:
        AssertTrue(
            fbATM.fbTempSensor1.FFO.i_xOK,
            &#39;Faulted even with low temp!&#39;,
        );
        nStep := nStep + 1;
END_CASE;

IF tonTimer.Q OR nStep &gt; nLastStep THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in ATM temp FFO test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-atm-states">E_ATM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-atm">FB_ATM</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-attenuatorelementdensity">
<h2>FB_AttenuatorElementDensity<a class="headerlink" href="#fb-attenuatorelementdensity" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_AttenuatorElementDensity</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">fDensity</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">fbElementDensity</span> <span class="p">:</span> <span class="n">FB_ElementDensity</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;C&#39;</span> <span class="n">THEN</span>
    <span class="p">(</span><span class="o">*</span> <span class="n">Special</span><span class="o">-</span><span class="n">case</span> <span class="n">diamond</span> <span class="n">here</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">fDensity</span> <span class="o">:=</span> <span class="mf">3.51E6</span><span class="p">;</span>  <span class="p">(</span><span class="o">*</span> <span class="n">C</span> <span class="p">(</span><span class="n">Diamond</span><span class="p">)</span> <span class="n">g</span><span class="o">/</span><span class="n">m</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span><span class="p">)</span>
<span class="n">ELSE</span>
    <span class="n">fbElementDensity</span><span class="p">(</span><span class="n">sName</span><span class="o">:=</span><span class="n">sName</span><span class="p">);</span>
    <span class="n">IF</span> <span class="n">fbElementDensity</span><span class="o">.</span><span class="n">bFound</span> <span class="n">THEN</span>
        <span class="n">fDensity</span> <span class="o">:=</span> <span class="n">fbElementDensity</span><span class="o">.</span><span class="n">fValue</span> <span class="o">*</span> <span class="mf">1.0E6</span><span class="p">;</span> <span class="p">(</span><span class="o">*</span> <span class="n">g</span><span class="o">/</span><span class="n">cm</span><span class="o">^</span><span class="mi">3</span> <span class="o">-&gt;</span> <span class="n">g</span><span class="o">/</span><span class="n">m</span><span class="o">^</span><span class="mi">3</span> <span class="o">*</span><span class="p">)</span>
    <span class="n">ELSE</span>
        <span class="n">fDensity</span> <span class="o">:=</span> <span class="mf">0.0</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-cc-tempsensor">
<h2>FB_CC_TempSensor<a class="headerlink" href="#fb-cc-tempsensor" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CC_TempSensor</span> <span class="n">EXTENDS</span> <span class="n">FB_TempSensor_FFO</span>
<span class="n">VAR</span>
    <span class="n">rtVetoReset</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Reset</span> <span class="n">the</span> <span class="n">FFO</span> <span class="k">for</span> <span class="n">transitions</span> <span class="n">to</span> <span class="n">bVeto</span>
<span class="o">//</span> <span class="n">bAutoreset</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">,</span> <span class="n">but</span> <span class="n">we</span> <span class="n">still</span> <span class="n">want</span> <span class="n">to</span> <span class="n">clear</span> <span class="n">the</span> <span class="n">fault</span> <span class="n">on</span> <span class="n">veto</span>
<span class="n">rtVetoReset</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bVeto</span><span class="p">);</span>
<span class="n">FFO</span><span class="o">.</span><span class="n">i_xReset</span> <span class="o">:=</span> <span class="n">rtVetoReset</span><span class="o">.</span><span class="n">Q</span><span class="p">;</span>

<span class="n">SUPER</span><span class="o">^</span><span class="p">(</span><span class="n">bAutoReset</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span> <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-cc-tempsensortest">
<h2>FB_CC_TempSensorTest<a class="headerlink" href="#fb-cc-tempsensortest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CC_TempSensorTest</span> <span class="n">EXTENDS</span> <span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
    <span class="n">fbTempSensor</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TestBasic</span><span class="p">();</span>
<span class="n">TestAutoReset</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">SetTempAndRunFB</span>
<span class="n">VAR_INPUT</span>
    <span class="n">iRawTemp</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">ptr</span><span class="p">:</span> <span class="n">POINTER</span> <span class="n">TO</span> <span class="n">INT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ptr</span> <span class="o">:=</span> <span class="n">ADR</span><span class="p">(</span><span class="n">fbTempSensor</span><span class="o">.</span><span class="n">iRaw</span><span class="p">);</span>
<span class="n">ptr</span><span class="o">^</span> <span class="o">:=</span> <span class="n">iRawTemp</span> <span class="o">*</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">fbTempSensor</span><span class="p">(</span><span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">);</span>
<span class="n">fbFFHWO</span><span class="o">.</span><span class="n">ExecuteNoLog</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestAutoReset</span>
<span class="n">VAR_INPUT</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestAutoReset&#39;</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">a</span> <span class="n">fixed</span> <span class="n">threshold</span> <span class="k">for</span> <span class="n">the</span> <span class="n">test</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">fFaultThreshold</span> <span class="o">:=</span> <span class="mi">30</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Clear</span> <span class="n">faults</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">]</span><span class="o">.</span><span class="n">BeamPermitted</span><span class="p">,</span>
    <span class="s1">&#39;Beam not permitted after full clear with low temp&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Cause</span> <span class="n">a</span> <span class="n">fault</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">]</span><span class="o">.</span><span class="n">BeamPermitted</span><span class="p">,</span>
    <span class="s1">&#39;Beam permitted after high temp&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Remove</span> <span class="n">the</span> <span class="n">fault</span> <span class="n">condition</span><span class="p">,</span> <span class="n">should</span> <span class="n">still</span> <span class="n">be</span> <span class="n">fauling</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">]</span><span class="o">.</span><span class="n">BeamPermitted</span><span class="p">,</span>
    <span class="s1">&#39;Beam permitted before manual reset&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">veto</span><span class="p">,</span> <span class="n">should</span> <span class="n">no</span> <span class="n">longer</span> <span class="n">be</span> <span class="n">faulting</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbFFHWO</span><span class="o">.</span><span class="n">astFF</span><span class="p">[</span><span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">RegistrationIdx</span><span class="p">]</span><span class="o">.</span><span class="n">BeamPermitted</span><span class="p">,</span>
    <span class="s1">&#39;Beam not permitted after veto&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>

<span class="n">METHOD</span> <span class="n">TestBasic</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestBasic&#39;</span><span class="p">);</span>

<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">fFaultThreshold</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">,</span>
    <span class="s1">&#39;Faulted with temp below threshold&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">fFaultThreshold</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">150</span><span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span>
    <span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">,</span>
    <span class="s1">&#39;Did not fault with temp above threshold&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">fFaultThreshold</span> <span class="o">:=</span> <span class="mi">5</span><span class="p">;</span>
<span class="n">fbTempSensor</span><span class="o">.</span><span class="n">bVeto</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">SetTempAndRunFB</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span>
    <span class="n">fbTempSensor</span><span class="o">.</span><span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span><span class="p">,</span>
    <span class="s1">&#39;Faulted with manual veto&#39;</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-checkpositionstatewrite">
<h2>FB_CheckPositionStateWrite<a class="headerlink" href="#fb-checkpositionstatewrite" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CheckPositionStateWrite</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Save</span> <span class="n">a</span> <span class="n">position</span> <span class="n">state</span> <span class="n">during</span> <span class="n">one</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">then</span> <span class="n">check</span> <span class="n">it</span> <span class="n">the</span> <span class="nb">next</span> <span class="n">cycle</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bCheck</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bSave</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="n">bHadWrite</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">astCache</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bHadWrite</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">IF</span> <span class="n">bCheck</span> <span class="n">THEN</span>
    <span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span> <span class="n">DO</span>
        <span class="o">//</span> <span class="n">Only</span> <span class="n">the</span> <span class="n">runtime</span><span class="o">-</span><span class="n">editable</span> <span class="n">EPICS</span> <span class="n">fields</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sName</span><span class="p">;</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span><span class="p">;</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDelta</span><span class="p">;</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fVelocity</span><span class="p">;</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fAccel</span><span class="p">;</span>
        <span class="n">bHadWrite</span> <span class="n">S</span><span class="o">=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">&lt;&gt;</span> <span class="n">astCache</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">fDecel</span><span class="p">;</span>
    <span class="n">END_FOR</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="n">bSave</span> <span class="n">THEN</span>
    <span class="n">astCache</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-checkpositionstatewritetest">
<h2>FB_CheckPositionStateWriteTest<a class="headerlink" href="#fb-checkpositionstatewritetest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_CheckPositionStateWriteTest</span> <span class="n">EXTENDS</span> <span class="n">FB_TestSuite</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">TestSaveCheck</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">TestSaveCheck</span>
<span class="n">VAR_INST</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbCheckPositionStateWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">TEST</span><span class="p">(</span><span class="s1">&#39;TestSaveCheck&#39;</span><span class="p">);</span>

<span class="n">fbCheckPositionStateWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbCheckPositionStateWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertFalse</span><span class="p">(</span><span class="n">fbCheckPositionStateWrite</span><span class="o">.</span><span class="n">bHadWrite</span><span class="p">,</span> <span class="s1">&#39;Saw a write when there was no write&#39;</span><span class="p">);</span>
<span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">fbCheckPositionStateWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">AssertTrue</span><span class="p">(</span><span class="n">fbCheckPositionStateWrite</span><span class="o">.</span><span class="n">bHadWrite</span><span class="p">,</span> <span class="s1">&#39;Did not detect position value changed&#39;</span><span class="p">);</span>

<span class="n">TEST_FINISHED</span><span class="p">();</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-fdq-flowmeter">
<h2>FB_FDQ_FlowMeter<a class="headerlink" href="#fb-fdq-flowmeter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_FDQ_FlowMeter</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Connect</span> <span class="n">this</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">terminal</span>
    <span class="n">iRaw</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">number</span> <span class="n">of</span> <span class="n">bits</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max value. This is not necessarily the resolution parameter.</span>
    <span class="n">iTermBits</span><span class="p">:</span> <span class="n">UINT</span> <span class="o">:=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s max value</span>
    <span class="n">fTermMax</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">60</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fReal</span> <span class="n">value</span> <span class="n">correlated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">terminal</span><span class="s1">&#39;s min value</span>
    <span class="n">fTermMin</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Value</span> <span class="n">to</span> <span class="n">scale</span> <span class="n">the</span> <span class="n">end</span> <span class="n">result</span> <span class="n">to</span>
    <span class="n">fResolution</span> <span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fOffset</span> <span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FWM</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="n">lpm</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbFlowMeter</span> <span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
<span class="n">END_VAR</span>
<span class="n">fbFlowMeter</span><span class="p">(</span><span class="n">iRaw</span> <span class="o">:=</span> <span class="n">iRaw</span><span class="p">,</span>
<span class="n">iTermBits</span><span class="o">:=</span><span class="n">iTermBits</span><span class="p">,</span>
<span class="n">fTermMax</span><span class="o">:=</span><span class="n">fTermMax</span><span class="p">,</span>
<span class="n">fTermMin</span><span class="o">:=</span><span class="n">fTermMin</span><span class="p">,</span>
<span class="n">fResolution</span><span class="o">:=</span><span class="n">fResolution</span><span class="p">,</span>
<span class="n">fOffset</span><span class="o">:=</span><span class="n">fOffset</span>
<span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-lic">
<h2>FB_LIC<a class="headerlink" href="#fb-lic" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_LIC</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">Laser</span> <span class="n">In</span><span class="o">-</span><span class="n">Coupling</span> <span class="p">(</span><span class="n">LIC</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">mirror</span> <span class="ow">and</span> <span class="n">target</span> <span class="n">states</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">MIRROR1</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stMirror1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">MIRROR2</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stMirror2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET1</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_LIC_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_LIC_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..4</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">State</span> <span class="n">defaults</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">provided</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">fOutDecel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fOutDecel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stMirror1</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;MIRROR1&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stMirror2</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;MIRROR2&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget1</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET1&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">MIRROR1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMirror1</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">MIRROR2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stMirror2</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">TARGET</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget1</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stMirror1</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">MIRROR1</span><span class="p">];</span>
<span class="n">stMirror2</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">MIRROR2</span><span class="p">];</span>
<span class="n">stTarget1</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_LIC_States</span><span class="o">.</span><span class="n">TARGET</span><span class="p">];</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-lic-states">E_LIC_States</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-lictest">
<h2>FB_LICTest<a class="headerlink" href="#fb-lictest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_LICTest EXTENDS FB_TestSuite
VAR
    fbLIC: FB_LIC;
    stYStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbLIC.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbLIC.stMirror1, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbLIC.stMirror2, sName:=&#39;T2&#39;, fPosition:=30, sPmpsState:=&#39;T2&#39;);

// Standard FB call
fbLIC(
    stYStage:=stYStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_LIC_States.MIRROR2;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestLICStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbLIC.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbLIC.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in LIC move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-lic-states">E_LIC_States</a></p></li>
<li><p><a class="reference internal" href="#fb-lic">FB_LIC</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-pmpsjsontesthelper">
<h2>FB_PMPSJsonTestHelper<a class="headerlink" href="#fb-pmpsjsontesthelper" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PMPSJsonTestHelper</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Create</span> <span class="n">a</span> <span class="n">JSON</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">memory</span> <span class="n">to</span> <span class="n">match</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">structs</span>
    <span class="n">Assumes</span> <span class="mi">1</span> <span class="n">device</span> <span class="k">for</span> <span class="n">simplicity</span>
    <span class="n">Writes</span> <span class="n">to</span> <span class="n">the</span> <span class="k">global</span> <span class="n">pmps</span> <span class="n">json</span> <span class="n">doc</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">astBeamParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sDevName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">rtExec</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">jsonRoot</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">jsonDevice</span><span class="p">:</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">ajsonState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">SJsonValue</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="p">:</span> <span class="n">FB_JsonDomParser</span><span class="p">;</span>

    <span class="n">nIter</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>
    <span class="n">nId</span><span class="p">:</span> <span class="n">DINT</span><span class="p">;</span>

    <span class="n">aseVRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asRate</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asBCRange</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">asTran</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">STRING</span><span class="p">;</span>

    <span class="n">sTemp</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sPress</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rtExec</span><span class="p">(</span><span class="n">CLK</span><span class="o">:=</span><span class="n">bExecute</span><span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">rtExec</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
    <span class="n">RETURN</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">jsonRoot</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">NewDocument</span><span class="p">();</span>
<span class="n">jsonDevice</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonRoot</span><span class="p">,</span> <span class="n">sDevName</span><span class="p">);</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="n">LOWER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">TO</span> <span class="n">UPPER_BOUND</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="n">DO</span>
    <span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">fbJson</span><span class="o">.</span><span class="n">AddObjectMember</span><span class="p">(</span><span class="n">jsonDevice</span><span class="p">,</span> <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">);</span>

    <span class="n">nId</span> <span class="o">:=</span> <span class="n">nId</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddIntMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;id&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">nId</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;beamline&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;tst&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">neVRange</span><span class="p">,</span> <span class="mi">32</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;neVRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">aseVRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">UDINT_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nRate</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nRate&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asRate</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ygap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xgap&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;damage_limit&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;notes&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">sTemp</span> <span class="o">:=</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_temp&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">sTemp</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">sPress</span> <span class="o">:=</span> <span class="n">TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nPressSP</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;reactive_pressure&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">sPress</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">bitmaskToString</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nBCRange</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nBeamClassRange&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asBCRange</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span> <span class="o">:=</span> <span class="n">REAL_TO_STRING</span><span class="p">(</span><span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span><span class="o">.</span><span class="n">nTran</span><span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;nTran&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">asTran</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_name&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;None&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_ycenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;ap_xcenter&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddStringMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;pulse_energy&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="p">);</span>
    <span class="n">fbJson</span><span class="o">.</span><span class="n">AddBoolMember</span><span class="p">(</span>
        <span class="n">v</span><span class="o">:=</span><span class="n">ajsonState</span><span class="p">[</span><span class="n">nIter</span><span class="p">],</span>
        <span class="n">member</span><span class="o">:=</span><span class="s1">&#39;special&#39;</span><span class="p">,</span>
        <span class="n">value</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="p">);</span>
<span class="n">END_FOR</span>

<span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span> <span class="o">:=</span> <span class="n">jsonRoot</span><span class="p">;</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">METHOD</span> <span class="n">bitmaskToString</span> <span class="p">:</span> <span class="n">STRING</span>
<span class="n">VAR_INPUT</span>
    <span class="n">nBitmask</span><span class="p">:</span> <span class="n">DWORD</span><span class="p">;</span>
    <span class="n">nBits</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">1</span> <span class="n">TO</span> <span class="n">nBits</span> <span class="n">DO</span>
    <span class="n">bitmaskToString</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="n">DWORD_TO_STRING</span><span class="p">(</span><span class="n">SHR</span><span class="p">(</span><span class="n">nBitmask</span><span class="p">,</span> <span class="n">nIter</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">AND</span> <span class="mi">1</span><span class="p">),</span> <span class="n">bitmaskToString</span><span class="p">);</span>
<span class="n">END_FOR</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
</section>
<section id="fb-positionstate-defaults">
<h2>FB_PositionState_Defaults<a class="headerlink" href="#fb-positionstate-defaults" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PositionState_Defaults</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stPositionState</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="n">sNameDefault</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">fVeloDefault</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDeltaDefault</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fAccelDefault</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fDecelDefault</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="n">OR</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">=</span> <span class="s1">&#39;Invalid&#39;</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="n">sNameDefault</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fVeloDefault</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fDeltaDefault</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fAccelDefault</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">stPositionState</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fDecelDefault</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-ppm">
<h2>FB_PPM<a class="headerlink" href="#fb-ppm" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PPM</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">Power</span> <span class="ow">and</span> <span class="n">Profile</span> <span class="n">Monitor</span> <span class="p">(</span><span class="n">PPM</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">power</span> <span class="ow">and</span> <span class="n">profile</span> <span class="n">states</span>
    <span class="o">-</span> <span class="n">power</span> <span class="n">meter</span>
    <span class="o">-</span> <span class="n">camera</span> <span class="n">power</span>
    <span class="o">-</span> <span class="n">camera</span> <span class="n">illuminator</span>
    <span class="o">-</span> <span class="n">flow</span> <span class="n">meter</span>
    <span class="o">-</span> <span class="n">thermocouple</span>

    <span class="n">The</span> <span class="n">following</span> <span class="n">IO</span> <span class="n">link</span> <span class="n">points</span> <span class="n">are</span> <span class="n">included</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbPowerMeter</span><span class="o">.</span><span class="n">iVoltageINT</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">power</span> <span class="n">meter</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">voltage</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbPowerMeter</span><span class="o">.</span><span class="n">fbThermoCouple</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="n">bUnderrange</span><span class="p">,</span> <span class="n">bOverrange</span><span class="p">,</span> <span class="ow">and</span> <span class="n">iRaw</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">thermocouple</span> <span class="n">terminal</span> <span class="n">inputs</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbGige</span><span class="o">.</span><span class="n">iIlluminatorINT</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">illuminator</span> <span class="n">dimmer</span> <span class="n">analog</span> <span class="n">output</span> <span class="n">voltage</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbGige</span><span class="o">.</span><span class="n">bGigePower</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">camera</span> <span class="n">power</span> <span class="n">digial</span> <span class="n">output</span> <span class="n">channel</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbFlowMeter</span><span class="o">.</span><span class="n">iRaw</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">flow</span> <span class="n">meter</span> <span class="n">current</span> <span class="n">analog</span> <span class="nb">input</span> <span class="n">channel</span>
    <span class="o">-</span> <span class="n">FB_PPM</span><span class="o">.</span><span class="n">fbYagThermoCouple</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="n">bUnderrange</span><span class="p">,</span> <span class="n">bOverrange</span><span class="p">,</span> <span class="ow">and</span> <span class="n">iRaw</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">thermocouple</span> <span class="n">terminal</span> <span class="n">inputs</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">POWERMETER</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stPower</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">YAG1</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stYag1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">YAG2</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stYag2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_PPM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Offset</span> <span class="k">for</span> <span class="n">the</span> <span class="n">flow</span> <span class="n">meter</span> <span class="ow">in</span> <span class="n">engineering</span> <span class="n">units</span>
    <span class="n">fFlowOffset</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Responsivity</span> <span class="k">for</span> <span class="n">power</span> <span class="n">meter</span>
    <span class="n">fResponsivity</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_PPM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..4</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: SPM&#39;</span><span class="p">}</span>
    <span class="n">fbPowerMeter</span><span class="p">:</span> <span class="n">FB_PPM_PowerMeter</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: CAM&#39;</span><span class="p">}</span>
    <span class="n">fbGige</span><span class="p">:</span> <span class="n">FB_PPM_Gige</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span><span class="s1">&#39;pv: FWM&#39;</span><span class="p">}</span>
    <span class="n">fbFlowMeter</span><span class="p">:</span> <span class="n">FB_AnalogInput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">60</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: YAG:STC&#39;</span><span class="p">}</span>
    <span class="n">fbYagTempSensor</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: FSW&#39;</span><span class="p">}</span>
    <span class="n">fbFlowSwitch</span><span class="p">:</span> <span class="n">FB_XTES_Flowswitch</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">State</span> <span class="n">defaults</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">provided</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">fOutDecel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fOutDecel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stPower</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;POWERMETER&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stYag1</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;YAG1&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stYag2</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;YAG2&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">POWERMETER</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stPower</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">YAG1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stYag1</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">YAG2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stYag2</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stPower</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">POWERMETER</span><span class="p">];</span>
<span class="n">stYag1</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">YAG1</span><span class="p">];</span>
<span class="n">stYag2</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_PPM_States</span><span class="o">.</span><span class="n">YAG2</span><span class="p">];</span>

<span class="n">fbPowerMeter</span><span class="p">(</span>
    <span class="n">fTempSP</span><span class="o">:=</span><span class="n">fbStates</span><span class="o">.</span><span class="n">stDbStateParams</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">bVetoTempFFO</span><span class="o">:=</span><span class="n">eEnumGet</span> <span class="o">=</span> <span class="n">E_PPM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">stYAxisState</span><span class="o">:=</span><span class="n">stYStage</span><span class="o">.</span><span class="n">Axis</span><span class="o">.</span><span class="n">NcToPlc</span><span class="o">.</span><span class="n">AxisState</span><span class="p">,</span>
    <span class="n">fResponsivity</span><span class="o">:=</span><span class="n">fResponsivity</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbGige</span><span class="p">();</span>
<span class="n">fbFlowMeter</span><span class="p">(</span><span class="n">fOffset</span><span class="o">:=</span><span class="n">fFlowOffset</span><span class="p">);</span>
<span class="n">fbYagTempSensor</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">fbStates</span><span class="o">.</span><span class="n">stDbStateParams</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">bVeto</span><span class="o">:=</span><span class="n">eEnumGet</span> <span class="o">=</span> <span class="n">E_PPM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFlowSwitch</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ppm-states">E_PPM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-ppm-gige">FB_PPM_Gige</a></p></li>
<li><p><a class="reference internal" href="#fb-ppm-powermeter">FB_PPM_PowerMeter</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
<li><p><a class="reference internal" href="#fb-xtes-flowswitch">FB_XTES_Flowswitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ppm-gige">
<h2>FB_PPM_Gige<a class="headerlink" href="#fb-ppm-gige" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_PPM_Gige</span>
<span class="n">VAR</span>
    <span class="n">iIlluminatorINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PWR</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span>
    <span class="s1">&#39;}</span>
    <span class="n">bGigePower</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CIL</span><span class="p">:</span><span class="n">PCT</span>
        <span class="n">EGU</span><span class="p">:</span> <span class="o">%</span>
    <span class="s1">&#39;}</span>
    <span class="n">fIlluminatorPercent</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">fbGetIllPercent</span><span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
    <span class="n">fbSetIllPercent</span><span class="p">:</span> <span class="n">FB_AnalogOutput</span><span class="p">;</span>

    <span class="n">bGigeInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Turn</span> <span class="n">the</span> <span class="n">GigE</span> <span class="n">on</span> <span class="n">by</span> <span class="n">default</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bGigeInit</span> <span class="n">THEN</span>
    <span class="n">bGigePower</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bGigeInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Illuminator</span> <span class="n">conversion</span> <span class="n">to</span> <span class="n">percentage</span>
<span class="n">fbSetIllPercent</span><span class="p">(</span>
    <span class="n">fReal</span><span class="o">:=</span><span class="n">fIlluminatorPercent</span><span class="p">,</span>
    <span class="n">fSafeMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fSafeMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iRaw</span><span class="o">=&gt;</span><span class="n">iIlluminatorINT</span><span class="p">);</span>
<span class="n">fbGetIllPercent</span><span class="p">(</span>
    <span class="n">iRaw</span><span class="o">:=</span><span class="n">iIlluminatorINT</span><span class="p">,</span>
    <span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">fReal</span><span class="o">=&gt;</span><span class="n">fIlluminatorPercent</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-ppm-powermeter">
<h2>FB_PPM_PowerMeter<a class="headerlink" href="#fb-ppm-powermeter" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPM_PowerMeter
VAR_INPUT
    fTempSP: REAL;
    bVetoTempFFO: BOOL;
    sDeviceName: STRING;

    // Used to know when to stop background auto-collection
    eEnumGet: E_PPM_States;
    stYAxisState: DWORD;

    // Calibrated for each gentec, should be passed as input
    // If not set, responsive energy will not be calculated
    {attribute &#39;pytmc&#39; := &#39;
        pv: RES
        io: i
        field: EGU V/W
    &#39;}
    fResponsivity: LREAL;
END_VAR
VAR_IN_OUT
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR
    iVoltageINT AT %I*: INT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: VOLT
        io: input
        field: EGU mV
    &#39;}
    fVoltage: LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: VOLT_BUFFER
        io: input
        field: EGU mV
    &#39;}
    fVoltageBuffer: ARRAY[1..1000] OF LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: STC
        io: input
    &#39;}
    fbTempSensor: FB_CC_TempSensor;


    fFrequency: REAL;
    // Used to get beam mode and rate
    {attribute &#39;pytmc&#39; := &#39;
        pv: SXRAccTypeFromEpics
        link: PHYS:UNDS:1:FACMODE.RVAL
    &#39;}
    uSXR_Accelerator: UINT;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SXR_NC_BeamRateFromEpics
        link: EVNT:SYS0:1:NC_SOFTRATE
    &#39;}
    fSXR_NC_Frequency: REAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: SXR_SC_BeamRateFromEpics
        link: TPG:SYS0:1:DST04:RATE
    &#39;}
    uSXR_SC_Frequency: UINT;

    {attribute &#39;pytmc&#39; := &#39;
        pv: HXRAccTypeFromEpics
        link: PHYS:UNDH:1:FACMODE.RVAL
    &#39;}
    uHXR_Accelerator: UINT;
    {attribute &#39;pytmc&#39; := &#39;
        pv: HXR_NC_BeamRateFromEpics
        link: EVNT:SYS0:1:NC_HARDRATE
    &#39;}
    fHXR_NC_Frequency: REAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: HXR_SC_BeamRateFromEpics
        link: TPG:SYS0:1:DST03:RATE
    &#39;}
    uHXR_SC_Frequency: UINT;

    // Pulse-by-pulse energy and buffer
    {attribute &#39;pytmc&#39; := &#39;
        pv: MJ
        io: i
        field: EGU mJ
    &#39;}
    fCalibMJ: LREAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: MJ_BUFFER
        io: i
        field: EGU mJ
    &#39;}
    fCalibMJBuffer: ARRAY[1..1000] OF LREAL;

    // Wattage and buffer
    {attribute &#39;pytmc&#39; := &#39;
        pv: WATT
        io: i
        field: EGU mW
    &#39;}
    fPulseWattage: LREAL;
    {attribute &#39;pytmc&#39; := &#39;
        pv: WATT_BUFFER
        io: i
        field: EGU mW
    &#39;}
    fPulseWattageBuffer: ARRAY[1..1000] OF LREAL;

    // Background voltage
    {attribute &#39;pytmc&#39; := &#39;
        pv: BACK:VOLT
        io: io
        field: EGU mV
    &#39;}
    fBackgroundVoltage: LREAL;

    // Internal variables for background voltage auto-collection
    fBackgroundVoltageAcc: LREAL;
    uAccCount: UINT;
    fBackgroundVoltageSum: LREAL;
    fBackgroundVoltageStale: LREAL;
    tonBackgroundAutoCollecting: TON;
    fBackgroundVoltageBuffer: ARRAY[1..100] OF LREAL;
    udBackgroundVoltageBufferIndex: UDINT := 1;
    rTrig_Background : R_TRIG;
    i: UDINT;
    // Used to reset auto-collected background buffer, and fBackgroundVoltage if in Passive mode
    {attribute &#39;pytmc&#39; := &#39;
        pv: BACK:RESET
        io: io
    &#39;}
    bResetAutoBackground: BOOL;

    // In manual mode, auto-background updates buffer but does not change fBackgroundVoltage
    {attribute &#39;pytmc&#39; := &#39;
        pv: BACK:MODE
        io: io
    &#39;}
    BACKGROUND_MODE: (Manual, Passive) := Passive;

    // Boolean to trigger collection of background voltages
    {attribute &#39;pytmc&#39; := &#39;
        pv: BACK:COLL
        io: io
    &#39;}
    bBackgroundCollect: BOOL;

    // Time in seconds to collect background voltages for
    {attribute &#39;pytmc&#39; := &#39;
        pv: BACK:TIME
        io: io
        field: EGU s
    &#39;}
    uBackgroundCollectionTime: UINT := 60;
    tofBackgroundCollecting: TOF;
    udBackgroundManualCount: UDINT;

    fbGetPMVoltage: FB_AnalogInput;

    fbVoltageBuffer: FB_LREALBuffer;
    fbPulseWattageBuffer: FB_LREALBuffer;
    fbCalibMJBuffer: FB_LREALBuffer;

    FFO: FB_FastFault :=(
        i_Desc := &#39;Fault occurs when the per-pulse energy reading is high enough to damage the power meter&#39;,
        i_TypeCode := 16#500);
    bOverAllowableEnergy: BOOL;
END_VAR
VAR_STAT CONSTANT
    // Voltage limits for wavelength ranges
    uSoftWavelengthEdge1: UINT := 300;
    uSoftWavelengthEdge1L: UINT := 299;
    uSoftWavelengthEdge2: UINT := 1000;
    uSoftWavelengthEdge2L: UINT := 999;
    uSoftWavelengthEdge3: UINT := 1560;
    uSoftWavelengthEdge3L: UINT := 1559;
    uSoftWavelengthEdge4: UINT := 2000;
    uSoftWavelengthEdge4L: UINT := 1999;

    uHardWavelengthEdge1: UINT := 1000;
    uHardWavelengthEdge2: UINT := 1500;
    uHardWavelengthEdge2L: UINT := 1499;
    uHardWavelengthEdge3: UINT := 4000;
    uHardWavelengthEdge3L: UINT := 3999;
END_VAR
fbTempSensor(
    fFaultThreshold:=fTempSP,
    bVeto:=bVetoTempFFO,
    sDevName:=sDeviceName,
    io_fbFFHWO:=fbFFHWO,
);

// Convert the terminal&#39;s integer into a value in millivolts
fbGetPMVoltage(
    iRaw := iVoltageINT,
    iTermBits := 15,
    fTermMax := 10000,
    fTermMin := 0,
    fReal =&gt; fVoltage);

rTrig_Background(CLK:=(eEnumGet &lt;&gt; E_PPM_States.OUT OR stYAxisState &lt;&gt; 0));
// Reset buffer and related variables
IF rTrig_Background.Q OR bResetAutoBackground THEN
    IF bResetAutoBackground THEN
        bResetAutoBackground := FALSE;
        IF BACKGROUND_MODE = Passive THEN
            fBackgroundVoltage := 0;
        END_IF
    ELSE
        // Dump 5s worth of readings
        IF udBackgroundVoltageBufferIndex &gt; 6 THEN
            FOR i := (udBackgroundVoltageBufferIndex - 5) TO (udBackgroundVoltageBufferIndex - 1) DO
                fBackgroundVoltageSum := fBackgroundVoltageSum - fBackgroundVoltageBuffer[((i-1) MOD 100) + 1];
            END_FOR
            udBackgroundVoltageBufferIndex := udBackgroundVoltageBufferIndex - 5;
            IF udBackgroundVoltageBufferIndex &lt;&gt; 1 AND BACKGROUND_MODE = Passive THEN
                fBackgroundVoltage := fBackgroundVoltageSum / MIN((udBackgroundVoltageBufferIndex - 1), 100);
            END_IF
        ELSIF BACKGROUND_MODE = Passive THEN
                fBackgroundVoltage := 0;
        END_IF
    END_IF
    fBackgroundVoltageAcc := 0;
    fBackgroundVoltageSum := 0;
    tonBackgroundAutoCollecting(IN := FALSE);
    udBackgroundVoltageBufferIndex := 1;
ELSIF eEnumGet = E_PPM_States.OUT AND stYAxisState = 0 THEN
    tonBackgroundAutoCollecting( IN := TRUE, PT := T#1000MS);
    // Every second, move fBackgroundVoltageAcc into buffer and sum
    IF tonBackgroundAutoCollecting.Q = TRUE THEN
        tonBackgroundAutoCollecting( IN := FALSE);
        fBackgroundVoltageStale := fBackgroundVoltageBuffer[((udBackgroundVoltageBufferIndex - 1) MOD 100) + 1];
        fBackgroundVoltageBuffer[((udBackgroundVoltageBufferIndex - 1) MOD 100) + 1] := fBackgroundVoltageAcc / uAccCount;
        // Remove overwritten voltage
        IF udBackgroundVoltageBufferIndex &gt; 100 THEN
            fBackgroundVoltageSum := fBackgroundVoltageSum - fBackgroundVoltageStale;
        END_IF
        fBackgroundVoltageSum := fBackgroundVoltageSum + fBackgroundVoltageAcc / uAccCount;
        fBackgroundVoltageAcc := fVoltage;
        uAccCount := 1;
        udBackgroundVoltageBufferIndex := udBackgroundVoltageBufferIndex + 1;
    ELSE
        uAccCount := uAccCount + 1;
        fBackgroundVoltageAcc := fBackgroundVoltageAcc + fVoltage;
    END_IF

END_IF

IF udBackgroundVoltageBufferIndex &lt;&gt; 1 AND BACKGROUND_MODE = Passive THEN
    fBackgroundVoltage := fBackgroundVoltageSum / MIN((udBackgroundVoltageBufferIndex - 1), 100);
END_IF

// Start collecting background in manual mode - 60s by default but can be set with uBackgroundCollectionTime
IF bBackgroundCollect = TRUE THEN
    bBackgroundCollect := FALSE;
    udBackgroundManualCount := 0;
    fBackgroundVoltage := 0;
    tofBackgroundCollecting(IN := TRUE);
END_IF


tofBackgroundCollecting(IN := FALSE, PT := UINT_TO_TIME(uBackgroundCollectionTime * 1000));
IF tofBackgroundCollecting.Q = TRUE THEN
    udBackgroundManualCount := udBackgroundManualCount + 1;
    IF BACKGROUND_MODE = Manual THEN
        fBackgroundVoltage := (fBackgroundVoltage * (udBackgroundManualCount - 1) + fVoltage) / udBackgroundManualCount;
    END_IF
END_IF

// Getting frequency based on accelerator source
(*
CASE uAccelerator OF
    0: uFrequency := uNCFrequency;
    1: uFrequency := uSCFrequency;
    2: uFrequency := 0; // ASTA?
ELSE
    uFrequency := 0;
END_CASE*)

{IF defined (K)}
    IF uSXR_Accelerator = 0 THEN
        fFrequency := fSXR_NC_Frequency;
    ELSIF uSXR_Accelerator = 1 THEN
        fFrequency := uSXR_SC_Frequency;
    END_IF
{ELSIF defined (L)}
    IF uHXR_Accelerator = 0 THEN
        fFrequency := fHXR_NC_Frequency;
    ELSIF uHXR_Accelerator = 1 THEN
        fFrequency := uHXR_SC_Frequency;
    END_IF
{END_IF}

// Getting wattage and energy
fPulseWattage := SEL(fResponsivity &lt;&gt; 0, 0, (fVoltage - fBackgroundVoltage) / fResponsivity);
fCalibMJ := SEL(fFrequency &lt;&gt; 0, -9999, fPulseWattage / fFrequency);

// FF in case voltage is high enough to damage power meter based on wavelength
{IF defined (K)}
    CASE REAL_TO_UINT(PMPS_GVL.cstFullBeam.neV) OF
        0 .. uSoftWavelengthEdge1L: bOverAllowableEnergy := fCalibMJ &gt; 2;
        uSoftWavelengthEdge1 .. uSoftWavelengthEdge2L : bOverAllowableEnergy := fCalibMJ &gt; 2;
        uSoftWavelengthEdge2 .. uSoftWavelengthEdge3L: bOverAllowableEnergy := fCalibMJ &gt; 4;
        uSoftWavelengthEdge3 .. uSoftWavelengthEdge4L: bOverAllowableEnergy := fCalibMJ &gt; 0.5;
        uSoftWavelengthEdge4 .. 65535: bOverAllowableEnergy := fCalibMJ &gt; 1;
    END_CASE
{ELSIF defined (L)}
    CASE REAL_TO_UINT(PMPS_GVL.cstFullBeam.neV) OF
        uHardWavelengthEdge1 .. uHardWavelengthEdge2L: bOverAllowableEnergy := fCalibMJ &gt; 10;
        uHardWavelengthEdge2 .. uHardWavelengthEdge3L: bOverAllowableEnergy := fCalibMJ &gt; 4;
        uHardWavelengthEdge3 .. 65535: bOverAllowableEnergy := fCalibMJ &gt; 10;
    END_CASE
{END_IF}
FFO(i_xOK := bOverAllowableEnergy,
    io_fbFFHWO := fbFFHWO);

// Buffer the full-rate Voltage, Pulse wattage, and calibrated MJ values
fbVoltageBuffer(
    bExecute := TRUE,
    fInput := fVoltage,
    arrOutput =&gt; fVoltageBuffer);
fbPulseWattageBuffer(
    bExecute := TRUE,
    fInput := fPulseWattage,
    arrOutput =&gt; fPulseWattageBuffer);
fbCalibMJBuffer(
    bExecute := TRUE,
    fInput := fCalibMJ,
    arrOutput =&gt; fCalibMJBuffer);

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ppm-states">E_PPM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ppmtest">
<h2>FB_PPMTest<a class="headerlink" href="#fb-ppmtest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_PPMTest EXTENDS FB_TestSuite
VAR
    fbPPM: FB_PPM;
    stYStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbPPM.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbPPM.stPower, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbPPM.stYag1, sName:=&#39;T2&#39;, fPosition:=30, sPmpsState:=&#39;T2&#39;);
fbSetup(stPositionState:=fbPPM.stYag2, sName:=&#39;T3&#39;, fPosition:=40, sPmpsState:=&#39;T3&#39;);

// Standard FB call
fbPPM(
    stYStage:=stYStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();
TestTempFFO();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD AssertBothTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertFalse(
    fbPPM.fbYagTempSensor.FFO.i_xOK,
    CONCAT(&#39;PPM yag temp sensor expected fault: &#39;, Message),
);
AssertFalse(
    fbPPM.fbPowerMeter.fbTempSensor.FFO.i_xOK,
    CONCAT(&#39;PPM pm temp sensor expected fault: &#39;, Message),
);
END_METHOD

METHOD AssertNeitherTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertTrue(
    fbPPM.fbYagTempSensor.FFO.i_xOK,
    CONCAT(&#39;PPM yag temp sensor expected ok: &#39;, Message),
);
AssertTrue(
    fbPPM.fbPowerMeter.fbTempSensor.FFO.i_xOK,
    CONCAT(&#39;PPM pm temp sensor expected ok: &#39;, Message),
);
END_METHOD

METHOD SetPPMTemp
VAR_INPUT
    iTempC: INT;
END_VAR
VAR
    ptr: POINTER TO INT;
END_VAR
ptr := ADR(fbPPM.fbYagTempSensor.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbPPM.fbPowerMeter.fbTempSensor.iRaw);
ptr^ := iTempC * 10;
END_METHOD

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_PPM_States.YAG2;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestPPMStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbPPM.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbPPM.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in PPM move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestTempFFO
VAR_INST
    tonTimer: TON;
    nStep: UINT := 0;
    bOutChecked: BOOL := FALSE;
    bInChecked: BOOL := FALSE;
END_VAR
VAR CONSTANT
    nLastStep: UINT := 3;
END_VAR
// Do we fault at the correct times?
// Parasitically depends on state move test
TEST(&#39;TestPPMTempFFO&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

CASE nStep OF
    0:
        // Set the thermocouple temperatures to crazy high number
        SetPPMTemp(100);
        nStep := nStep + 1;
    1:
        // Wait till we see &quot;OUT&quot; state and one other state (OUT should be no fault)
        IF fbPPM.eEnumGet = E_PPM_States.OUT THEN
            AssertNeitherTempFault(&#39;was in out position&#39;);
            bOutChecked := TRUE;
        ELSIF fbPPM.eEnumGet &lt;&gt; E_PPM_States.Unknown THEN
            AssertBothTempFault(&#39;was in a target position&#39;);
            bInChecked := TRUE;
        END_IF
        IF bOutChecked AND bInChecked THEN
            nStep := nStep + 1;
        END_IF
    2:
        // Set the thermocouple temperatures to low again
        SetPPMTemp(0);
        nStep := nStep + 1;
    3:
        AssertNeitherTempFault(&#39;has low temp reading&#39;);
        nStep := nStep + 1;
END_CASE;

IF tonTimer.Q OR nStep &gt; nLastStep THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in PPM temp FFO test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-ppm-states">E_PPM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-ppm">FB_PPM</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ref">
<h2>FB_REF<a class="headerlink" href="#fb-ref" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_REF</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">reference</span> <span class="n">laser</span> <span class="p">(</span><span class="n">REF</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="ow">in</span> <span class="ow">and</span> <span class="n">out</span> <span class="n">states</span>
    <span class="o">-</span> <span class="n">laser</span> <span class="n">power</span> <span class="ow">and</span> <span class="n">dimmer</span>

    <span class="n">The</span> <span class="n">following</span> <span class="n">IO</span> <span class="n">link</span> <span class="n">points</span> <span class="n">are</span> <span class="n">included</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_REF</span><span class="o">.</span><span class="n">fbLaser</span><span class="o">.</span><span class="n">iShutdownINT</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">output</span> <span class="k">for</span> <span class="n">the</span> <span class="n">laser</span> <span class="n">dimmer</span><span class="s1">&#39;s shutdown voltage</span>
    <span class="o">-</span> <span class="n">FB_REF</span><span class="o">.</span><span class="n">fbLaser</span><span class="o">.</span><span class="n">iLaserINT</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">output</span> <span class="k">for</span> <span class="n">the</span> <span class="n">laser</span> <span class="n">dimmer</span><span class="s1">&#39;s dimmer</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">IN</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stIn</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_EpicsInOut</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..2</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: LAS&#39;</span><span class="p">}</span>
    <span class="n">fbLaser</span><span class="p">:</span> <span class="n">FB_REF_Laser</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stIn</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;IN&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stIn</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stIn</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_EpicsInOut</span><span class="o">.</span><span class="n">IN</span><span class="p">];</span>

<span class="n">fbLaser</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
<li><p><a class="reference internal" href="#fb-ref-laser">FB_REF_Laser</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-ref-laser">
<h2>FB_REF_Laser<a class="headerlink" href="#fb-ref-laser" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_REF_Laser</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bShutdown</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PCT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLaserPercent</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">iShutdownINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>
    <span class="n">iLaserINT</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">INT</span><span class="p">;</span>

    <span class="n">fbGetLasPercent</span><span class="p">:</span> <span class="n">FB_AnalogInput</span><span class="p">;</span>
    <span class="n">fbSetLasPercent</span><span class="p">:</span> <span class="n">FB_AnalogOutput</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Send</span> <span class="mi">5</span><span class="n">V</span> <span class="n">to</span> <span class="n">suppress</span> <span class="n">laser</span>
<span class="n">IF</span> <span class="n">bShutdown</span> <span class="n">THEN</span>
    <span class="n">iShutdownINT</span> <span class="o">:=</span> <span class="n">LREAL_TO_INT</span><span class="p">(</span><span class="n">EXPT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">14</span><span class="p">));</span>
<span class="n">ELSE</span>
    <span class="n">iShutdownINT</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">Limit</span> <span class="n">to</span> <span class="mi">0</span><span class="o">-</span><span class="mi">5</span><span class="n">V</span> <span class="n">instead</span> <span class="n">of</span> <span class="mi">10</span><span class="n">V</span>
<span class="n">fbSetLasPercent</span><span class="p">(</span>
    <span class="n">fReal</span><span class="o">:=</span><span class="n">fLaserPercent</span><span class="p">,</span>
    <span class="n">fSafeMax</span><span class="o">:=</span><span class="mi">100</span><span class="p">,</span>
    <span class="n">fSafeMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">iRaw</span><span class="o">=&gt;</span><span class="n">iLaserInt</span><span class="p">);</span>
<span class="n">fbGetLasPercent</span><span class="p">(</span>
    <span class="n">iRaw</span><span class="o">:=</span><span class="n">iLaserInt</span><span class="p">,</span>
    <span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span>
    <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">200</span><span class="p">,</span>
    <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">,</span>
    <span class="n">fReal</span><span class="o">=&gt;</span><span class="n">fLaserPercent</span><span class="p">);</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-reftest">
<h2>FB_REFTest<a class="headerlink" href="#fb-reftest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_REFTest EXTENDS FB_TestSuite
VAR
    fbREF: FB_REF;
    stYStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbREF.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbREF.stIn, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);

// Standard FB call
fbREF(
    stYStage:=stYStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_EpicsInOut.IN;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestREFStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbREF.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbREF.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in REF move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-ref">FB_REF</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-satttest">
<h2>FB_SATTTest<a class="headerlink" href="#fb-satttest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_SATTTest EXTENDS FB_TestSuite
VAR
    fbSATT: FB_SXR_SATT_Stage;
    stYStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fDelta:=0.5,
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;

    bInit: BOOL;
END_VAR
// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbSATT.stOut, sName:=&#39;OUT&#39;, fPosition:=10);
fbSetup(stPositionState:=fbSATT.stFilter1, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbSATT.stFilter2, sName:=&#39;T2&#39;, fPosition:=30);
fbSetup(stPositionState:=fbSATT.stFilter3, sName:=&#39;T3&#39;, fPosition:=40);
fbSetup(stPositionState:=fbSATT.stFilter4, sName:=&#39;T4&#39;, fPosition:=50);
fbSetup(stPositionState:=fbSATT.stFilter5, sName:=&#39;T5&#39;, fPosition:=60);
fbSetup(stPositionState:=fbSATT.stFilter6, sName:=&#39;T6&#39;, fPosition:=70);
fbSetup(stPositionState:=fbSATT.stFilter7, sName:=&#39;T7&#39;, fPosition:=80);
fbSetup(stPositionState:=fbSATT.stFilter8, sName:=&#39;T8&#39;, fPosition:=90);

// Standard FB call
fbSATT(
    stAxis:=stYStage,
    fbFFHWO:=fbFFHWO,
    bEnable:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
);

TestStateMove();
TestTempFFO();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD AssertBothTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertFalse(
    fbSATT.fbRTD_1.FFO.i_xOK,
    CONCAT(&#39;SATT RTD1 expected fault: &#39;, Message),
);
AssertFalse(
    fbSATT.fbRTD_2.FFO.i_xOK,
    CONCAT(&#39;SATT RTD2 expected fault: &#39;, Message),
);
END_METHOD

METHOD AssertNeitherTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertTrue(
    fbSATT.fbRTD_1.FFO.i_xOK,
    CONCAT(&#39;SATT RTD1 expected ok: &#39;, Message),
);
AssertTrue(
    fbSATT.fbRTD_2.FFO.i_xOK,
    CONCAT(&#39;SATT RTD2 expected ok: &#39;, Message),
);
END_METHOD

METHOD SetSATTTemp
VAR_INPUT
    iTempC: INT;
END_VAR
VAR
    ptr: POINTER TO INT;
END_VAR
ptr := ADR(fbSATT.fbRTD_1.iRaw);
ptr^ := iTempC * 100;

ptr := ADR(fbSATT.fbRTD_2.iRaw);
ptr^ := iTempC * 100;
END_METHOD

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_SXR_SATT_Position.FILTER8;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestSATTStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#20s);

// Start in Unknown, then go through the state positions one by one
IF fbSATT.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbSATT.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in SATT move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestTempFFO
VAR_INST
    tonTimer: TON;
    nStep: UINT := 0;
    bOutChecked: BOOL := FALSE;
    bInChecked: BOOL := FALSE;
END_VAR
VAR CONSTANT
    nLastStep: UINT := 3;
END_VAR
// Do we fault at the correct times?
// Parasitically depends on state move test
TEST(&#39;TestSATTTempFFO&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

CASE nStep OF
    0:
        // Set the thermocouple temperatures to crazy high number
        SetSATTTemp(100);
        nStep := nStep + 1;
    1:
        // Wait till we see &quot;OUT&quot; state and one other state (OUT should be no fault)
        IF fbSATT.eEnumGet = E_SXR_SATT_Position.OUT THEN
            AssertNeitherTempFault(&#39;was in out position&#39;);
            bOutChecked := TRUE;
        ELSIF fbSATT.eEnumGet &lt;&gt; E_SXR_SATT_Position.Unknown THEN
            AssertBothTempFault(&#39;was in a target position&#39;);
            bInChecked := TRUE;
        END_IF
        IF bOutChecked AND bInChecked THEN
            nStep := nStep + 1;
        END_IF
    2:
        // Set the thermocouple temperatures to low again
        SetSATTTemp(0);
        nStep := nStep + 1;
    3:
        AssertNeitherTempFault(&#39;has low temp reading&#39;);
        nStep := nStep + 1;
END_CASE;

IF tonTimer.Q OR nStep &gt; nLastStep THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in SATT temp FFO test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-sxr-satt-position">E_SXR_SATT_Position</a></p></li>
<li><p><a class="reference internal" href="#fb-sxr-satt-stage">FB_SXR_SATT_Stage</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-slits">
<h2>FB_SLITS<a class="headerlink" href="#fb-slits" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;analysis&#39;</span> <span class="o">:=</span> <span class="s1">&#39;-33&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SLITS</span>

<span class="n">VAR_IN_OUT</span>
    <span class="n">stTopBlade</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stBottomBlade</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stNorthBlade</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">stSouthBlade</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="n">bExecuteMotion</span><span class="p">:</span><span class="n">BOOL</span> <span class="p">;</span>
    <span class="n">io_fbFFHWO</span>    <span class="p">:</span>    <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">();</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">PMPS_OK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bMoveOk</span><span class="p">:</span><span class="n">BOOL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Offsets</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">Offset_Top</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rEncoderOffsetTop</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ZeroOffset_Bottom</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rEncoderOffsetBottom</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ZeroOffset_North</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rEncoderOffsetNorth</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ZeroOffset_South</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rEncoderOffsetSouth</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">i_DevName</span> <span class="p">:</span> <span class="n">STRING</span><span class="p">;</span> <span class="o">//</span><span class="n">device</span> <span class="n">name</span> <span class="k">for</span> <span class="n">FFO</span> <span class="ow">and</span> <span class="n">PMPS</span> <span class="n">diagnostics</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="n">fbTopBlade</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbBottomBlade</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbNorthBlade</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbSouthBlade</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fPosTopBlade</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosBottomBlade</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosNorthBlade</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosSouthBlade</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">Motion</span> <span class="n">Parameters</span><span class="o">*</span><span class="p">)</span>
    <span class="n">fSmallDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.01</span><span class="p">;</span>
    <span class="n">fBigDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">fMaxVelocity</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.2</span><span class="p">;</span>
    <span class="n">fHighAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.8</span><span class="p">;</span>
    <span class="n">fLowAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mf">0.1</span><span class="p">;</span>

    <span class="n">stTop</span><span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
    <span class="n">stBOTTOM</span><span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
    <span class="n">stNorth</span><span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>
    <span class="n">stSouth</span><span class="p">:</span> <span class="n">DUT_PositionState</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: TOP&#39;</span><span class="p">}</span>
    <span class="n">fbTop</span><span class="p">:</span> <span class="n">FB_StatePTPMove</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: BOTTOM&#39;</span><span class="p">}</span>
    <span class="n">fbBottom</span><span class="p">:</span> <span class="n">FB_StatePTPMove</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: NORTH&#39;</span><span class="p">}</span>
    <span class="n">fbNorth</span><span class="p">:</span> <span class="n">FB_StatePTPMove</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: SOUTH&#39;</span><span class="p">}</span>
    <span class="n">fbSouth</span><span class="p">:</span> <span class="n">FB_StatePTPMove</span><span class="p">;</span>

    <span class="p">(</span><span class="o">*</span><span class="n">EPICS</span> <span class="n">pvs</span><span class="o">*</span><span class="p">)</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">XWID_REQ</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqApertureSizeX</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">YWID_REQ</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqApertureSizeY</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">XCEN_REQ</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqCenterX</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">YCEN_REQ</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rReqCenterY</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ACTUAL_XWIDTH</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rActApertureSizeX</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ACTUAL_YWIDTH</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rActApertureSizeY</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ACTUAL_XCENTER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rActCenterX</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">ACTUAL_YCENTER</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rActCenterY</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">XCEN_SETZERO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rSetCenterX</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">YCEN_SETZERO</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">rSetCenterY</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">OPEN</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bOpen</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">CLOSE</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bClose</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">BLOCK</span><span class="p">;</span>
    <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="kc">False</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="kc">True</span>
    <span class="s1">&#39;}</span>
    <span class="n">bBlock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span><span class="n">Local</span> <span class="n">variables</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span><span class="n">true</span><span class="p">;</span>
    <span class="n">rTrig_Block</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rTrig_Open</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">rTrig_Close</span><span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="o">//</span><span class="n">old</span> <span class="n">values</span>
    <span class="n">rOldReqApertureSizeX</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rOldReqApertureSizeY</span> <span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rOldReqCenterX</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>
    <span class="n">rOldReqCenterY</span><span class="p">:</span> <span class="n">REAL</span><span class="p">;</span>

    <span class="n">bExecuteMotionX</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bExecuteMotionY</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>


    <span class="n">fPosBlock</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosClose</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
    <span class="n">fPosOpen</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>

    <span class="n">stSetPositionOptions</span><span class="p">:</span> <span class="n">ST_SetPositionOptions</span><span class="p">;</span>
    <span class="n">fbSetPosition_TOP</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbSetPosition_Bottom</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbSetPosition_North</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>
    <span class="n">fbSetPosition_South</span><span class="p">:</span> <span class="n">MC_SetPosition</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">For</span> <span class="n">logging</span>
    <span class="n">fbLogger</span> <span class="p">:</span> <span class="n">FB_LogMessage</span> <span class="o">:=</span> <span class="p">(</span><span class="n">eSubsystem</span><span class="o">:=</span><span class="n">E_SubSystem</span><span class="o">.</span><span class="n">MOTION</span><span class="p">);</span>
    <span class="n">tErrorPresent</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tAction</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>
    <span class="n">tOverrideActivated</span> <span class="p">:</span> <span class="n">R_TRIG</span><span class="p">;</span>

    <span class="n">FFO</span>    <span class="p">:</span>    <span class="n">FB_FastFault</span> <span class="o">:=</span><span class="p">(</span>
        <span class="n">i_DevName</span> <span class="o">:=</span> <span class="s1">&#39;Slits&#39;</span><span class="p">,</span>
        <span class="n">i_Desc</span> <span class="o">:=</span> <span class="s1">&#39;Fault occurs when gaps and/or centers are not within safe margins, or PMPS mode is switched OFF&#39;</span><span class="p">,</span>
        <span class="n">i_TypeCode</span> <span class="o">:=</span> <span class="mi">16</span><span class="c1">#FAA);</span>

    <span class="n">AptArrayStatus</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture_IO</span><span class="p">;</span>
    <span class="n">AptArrayReq</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span> <span class="p">:</span> <span class="n">ST_PMPS_Aperture_IO</span><span class="p">;</span>

    <span class="n">bTest</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">rTrig_Block</span> <span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">bBlock</span><span class="p">);</span>
<span class="n">rTrig_Open</span> <span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">bOpen</span><span class="p">);</span>
<span class="n">rTrig_Close</span> <span class="p">(</span><span class="n">CLK</span><span class="o">:=</span> <span class="n">bClose</span><span class="p">);</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rTrig_Block</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="o">//</span><span class="n">BLOCK</span>

    <span class="n">bBlock</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rTrig_Open</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>


    <span class="n">bOpen</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="k">if</span> <span class="p">(</span><span class="n">rTrig_Close</span><span class="o">.</span><span class="n">Q</span><span class="p">)</span> <span class="n">THEN</span>


    <span class="n">bClose</span> <span class="o">:=</span> <span class="n">false</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_CalculatePositions</span><span class="p">:</span>
<span class="o">//</span><span class="n">check</span> <span class="k">if</span> <span class="n">requested</span> <span class="n">center</span> <span class="ow">or</span> <span class="n">gap</span> <span class="n">has</span> <span class="n">changed</span>
<span class="o">//</span><span class="n">check</span> <span class="n">that</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">values</span> <span class="n">are</span> <span class="n">within</span> <span class="n">acceptable</span> <span class="n">motion</span> <span class="nb">range</span>
<span class="n">IF</span> <span class="p">(</span><span class="n">rOldReqApertureSizeX</span> <span class="o">&lt;&gt;</span> <span class="n">rReqApertureSizeX</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">rReqApertureSizeX</span> <span class="o">&lt;=</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Width</span><span class="p">)</span>  <span class="n">THEN</span>
        <span class="n">rOldReqApertureSizeX</span> <span class="o">:=</span> <span class="n">rReqApertureSizeX</span><span class="p">;</span>
        <span class="n">bExecuteMotionX</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new X gap.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new X gap is larger than PMPS request.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
    <span class="n">END_IF</span>
  <span class="o">//</span>  <span class="n">ELSE</span>
    <span class="o">//</span>    <span class="n">rReqApertureSizeX</span> <span class="o">:=</span> <span class="n">rActApertureSizeX</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rOldReqCenterX</span> <span class="o">&lt;&gt;</span> <span class="n">rReqCenterX</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">rOldReqCenterX</span> <span class="o">:=</span> <span class="n">rReqCenterX</span><span class="p">;</span>
    <span class="n">bExecuteMotionX</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new X center&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
   <span class="o">//</span> <span class="n">ELSE</span>
      <span class="o">//</span>  <span class="n">rReqCenterX</span> <span class="o">:=</span> <span class="n">rActCenterX</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rOldReqApertureSizeY</span> <span class="o">&lt;&gt;</span> <span class="n">rReqApertureSizeY</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">rReqApertureSizeY</span> <span class="o">&lt;=</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Height</span> <span class="n">THEN</span>
        <span class="n">rOldReqApertureSizeY</span> <span class="o">:=</span> <span class="n">rReqApertureSizeY</span><span class="p">;</span>
        <span class="n">bExecuteMotionY</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new Y gap.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
    <span class="n">ELSE</span>
        <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new Y gap is larger than PMPS request.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
    <span class="n">END_IF</span>
   <span class="o">//</span> <span class="n">ELSE</span>
       <span class="o">//</span> <span class="n">rReqApertureSizeY</span> <span class="o">:=</span> <span class="n">rActApertureSizeY</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">rOldReqCenterY</span> <span class="o">&lt;&gt;</span> <span class="n">rReqCenterY</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">rOldReqCenterY</span> <span class="o">:=</span> <span class="n">rReqCenterY</span><span class="p">;</span>
    <span class="n">bExecuteMotionY</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">fbLogger</span><span class="p">(</span><span class="n">sMsg</span><span class="o">:=</span><span class="s1">&#39;Requested new Y center.&#39;</span><span class="p">,</span> <span class="n">eSevr</span><span class="o">:=</span><span class="n">TcEventSeverity</span><span class="o">.</span><span class="n">Verbose</span><span class="p">);</span>
   <span class="o">//</span> <span class="n">ELSE</span>
      <span class="o">//</span>  <span class="n">rReqCenterY</span> <span class="o">:=</span> <span class="n">rActCenterY</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="o">//</span><span class="n">Calculate</span> <span class="n">requested</span> <span class="n">target</span> <span class="n">positions</span> <span class="kn">from</span> <span class="nn">requested</span> <span class="n">gap</span> <span class="ow">and</span> <span class="n">center</span>
<span class="n">fPosTopBlade</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rReqApertureSizeY</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rReqCenterY</span> <span class="o">+</span> <span class="n">rEncoderOffsetTop</span><span class="p">)</span> <span class="p">;</span>
<span class="n">fPosBottomBlade</span> <span class="o">:=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">rReqApertureSizeY</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rReqCenterY</span><span class="o">+</span><span class="n">rEncoderOffsetBottom</span><span class="p">);</span>

<span class="n">fPosNorthBlade</span> <span class="o">:=</span> <span class="p">(</span><span class="n">rReqApertureSizeX</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rReqCenterX</span> <span class="o">+</span> <span class="n">rEncoderOffsetNorth</span><span class="p">);</span>
<span class="n">fPosSouthBlade</span> <span class="o">:=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="o">*</span><span class="n">rReqApertureSizeX</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rReqCenterX</span> <span class="o">+</span> <span class="n">rEncoderOffsetSouth</span><span class="p">);</span>


<span class="o">//</span><span class="n">Calculate</span> <span class="n">actual</span> <span class="n">gap</span> <span class="ow">and</span> <span class="n">center</span> <span class="kn">from</span> <span class="nn">actual</span> <span class="n">stages</span> <span class="n">positions</span>
<span class="n">rActApertureSizeX</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">((</span><span class="n">stNorthBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetNorth</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">stSouthBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span><span class="o">-</span> <span class="n">rEncoderOffsetSouth</span><span class="p">));</span>

<span class="n">rActApertureSizeY</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">((</span><span class="n">stTopBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetTop</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">stBottomBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetBottom</span><span class="p">));</span>

<span class="n">rActCenterX</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">((((</span><span class="n">stNorthBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetNorth</span><span class="p">)</span>  <span class="o">+</span> <span class="p">(</span><span class="n">stSouthBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetSouth</span> <span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>

<span class="n">rActCenterY</span> <span class="o">:=</span> <span class="n">LREAL_TO_REAL</span><span class="p">((((</span><span class="n">stTopBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetTop</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">stBottomBlade</span><span class="o">.</span><span class="n">stAxisStatus</span><span class="o">.</span><span class="n">fActPosition</span> <span class="o">-</span> <span class="n">rEncoderOffsetBottom</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">));</span>



<span class="o">//</span><span class="n">Update</span> <span class="n">PMPS</span> <span class="n">Arbiter</span> <span class="k">with</span> <span class="n">the</span> <span class="n">Actual</span> <span class="n">Size</span> <span class="ow">and</span> <span class="n">Center</span> <span class="n">of</span> <span class="n">the</span> <span class="n">Aperture</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Home</span><span class="p">:</span>

<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Init</span><span class="p">:</span>
<span class="o">//</span>  <span class="n">init</span> <span class="n">the</span> <span class="n">motion</span> <span class="n">stages</span> <span class="n">parameters</span>
<span class="n">IF</span> <span class="p">(</span> <span class="n">bInit</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">stTopBlade</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stBottomBlade</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stNorthBlade</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stSouthBlade</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stTopBlade</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stBottomBlade</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stNorthBlade</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stSouthBlade</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stTopBlade</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">:=</span> <span class="n">ENUM_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">;</span>
    <span class="n">stBottomBlade</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">:=</span> <span class="n">ENUM_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">;</span>
    <span class="n">stNorthBlade</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">:=</span> <span class="n">ENUM_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">;</span>
    <span class="n">stSouthBlade</span><span class="o">.</span><span class="n">nBrakeMode</span> <span class="o">:=</span> <span class="n">ENUM_StageBrakeMode</span><span class="o">.</span><span class="n">NO_BRAKE</span><span class="p">;</span>
    <span class="n">FFO</span><span class="o">.</span><span class="n">i_DevName</span> <span class="o">:=</span> <span class="n">i_DevName</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_Motion</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Instantiate</span> <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">blades</span>
<span class="n">fbTopBlade</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stTopBlade</span><span class="p">);</span>
<span class="n">fbBottomBlade</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stBottomBlade</span><span class="p">);</span>
<span class="n">fbNorthBlade</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stNorthBlade</span><span class="p">);</span>
<span class="n">fbSouthBlade</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stSouthBlade</span><span class="p">);</span>

<span class="o">//</span> <span class="n">PTP</span> <span class="n">Motion</span> <span class="k">for</span> <span class="n">each</span> <span class="n">blade</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Top&#39;</span><span class="p">;</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosTopBlade</span><span class="p">;</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fSmallDelta</span><span class="p">;</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fMaxVelocity</span><span class="p">;</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>
<span class="n">stTop</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>

<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;Bottom&#39;</span><span class="p">;</span>
<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosBottomBlade</span><span class="p">;</span>
<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fSmallDelta</span><span class="p">;</span>
<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fMaxVelocity</span><span class="p">;</span>
<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>
<span class="n">stBOTTOM</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>

<span class="n">stNorth</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;North&#39;</span><span class="p">;</span>
<span class="n">stNorth</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosNorthBlade</span><span class="p">;</span>
<span class="n">stNorth</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fSmallDelta</span><span class="p">;</span>
<span class="n">stNorth</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fMaxVelocity</span><span class="p">;</span>
<span class="n">stNorth</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>
<span class="n">stNorth</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>

<span class="n">stSouth</span><span class="o">.</span><span class="n">sName</span> <span class="o">:=</span> <span class="s1">&#39;South&#39;</span><span class="p">;</span>
<span class="n">stSouth</span><span class="o">.</span><span class="n">fPosition</span> <span class="o">:=</span> <span class="n">fPosSouthBlade</span><span class="p">;</span>
<span class="n">stSouth</span><span class="o">.</span><span class="n">fDelta</span> <span class="o">:=</span> <span class="n">fSmallDelta</span><span class="p">;</span>
<span class="n">stSouth</span><span class="o">.</span><span class="n">fVelocity</span> <span class="o">:=</span> <span class="n">fMaxVelocity</span><span class="p">;</span>
<span class="n">stSouth</span><span class="o">.</span><span class="n">fAccel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>
<span class="n">stSouth</span><span class="o">.</span><span class="n">fDecel</span> <span class="o">:=</span> <span class="n">fHighAccel</span><span class="p">;</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bExecuteMotionY</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbTop</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">fbBottom</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecuteMotionY</span><span class="p">;</span>
    <span class="n">bExecuteMotionY</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">IF</span> <span class="p">(</span><span class="n">bExecuteMotionX</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">fbNorth</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">fbSouth</span><span class="o">.</span><span class="n">bExecute</span> <span class="o">:=</span> <span class="n">bExecuteMotionX</span><span class="p">;</span>
    <span class="n">bExecuteMotionX</span><span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="n">fbTop</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTop</span><span class="p">,</span>
    <span class="n">bMoveOk</span><span class="o">:=</span><span class="n">bMoveOk</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stTopBlade</span><span class="p">);</span>

<span class="n">fbBottom</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stBOTTOM</span><span class="p">,</span>
    <span class="n">bMoveOk</span><span class="o">:=</span><span class="n">bMoveOk</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stBottomBlade</span><span class="p">);</span>

<span class="n">fbNorth</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stNorth</span><span class="p">,</span>
    <span class="n">bMoveOk</span><span class="o">:=</span><span class="n">bMoveOk</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stNorthBlade</span><span class="p">);</span>

<span class="n">fbSouth</span><span class="p">(</span>
    <span class="n">stPositionState</span><span class="o">:=</span><span class="n">stSouth</span><span class="p">,</span>
    <span class="n">bMoveOk</span><span class="o">:=</span><span class="n">bMoveOk</span><span class="p">,</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stSouthBlade</span><span class="p">);</span>
<span class="n">END_ACTION</span>
</pre></div>
</div>
</section>
<section id="fb-slits-power">
<h2>FB_SLITS_POWER<a class="headerlink" href="#fb-slits-power" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_SLITS_POWER</span> <span class="n">EXTENDS</span> <span class="n">FB_SLITS</span>

<span class="n">VAR_INPUT</span>
    <span class="n">sPmpsState</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>

<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
    <span class="n">pv</span><span class="p">:</span> <span class="n">MODE</span> <span class="p">;</span>
     <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Local</span><span class="p">;</span>
    <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">PMPS</span><span class="p">;</span>
     <span class="n">io</span><span class="p">:</span> <span class="n">io</span><span class="p">;</span>
    <span class="s1">&#39;}</span>
    <span class="n">xPMPSMode</span>       <span class="p">:</span><span class="n">BOOL</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">;</span>

     <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FSW</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbFlowSwitch</span><span class="p">:</span> <span class="n">FB_XTES_Flowswitch</span><span class="p">;</span>

    <span class="o">//</span><span class="n">RTDs</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TOP</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_TOP_1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">TOP</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_TOP_2</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BOTTOM</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_Bottom_1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">BOTTOM</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_Bottom_2</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">NORTH</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_North_1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">NORTH</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_North_2</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SOUTH</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">01</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_South_1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SOUTH</span><span class="p">:</span><span class="n">RTD</span><span class="p">:</span><span class="mi">02</span>
    <span class="s1">&#39;}</span>
    <span class="n">RTD_South_2</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="n">fbReadPMPSDB</span><span class="p">:</span> <span class="n">FB_JsonDocToSafeBP</span><span class="p">;</span>
    <span class="n">astTempDB</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1..1</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">ACT_init</span><span class="p">();</span>
<span class="o">//</span> <span class="n">Instantiate</span> <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">blades</span>
<span class="n">ACT_Motion</span><span class="p">();</span>
<span class="o">//</span><span class="n">SET</span> <span class="ow">and</span> <span class="n">GET</span> <span class="n">the</span> <span class="n">requested</span> <span class="ow">and</span> <span class="n">Actual</span> <span class="n">values</span>
<span class="n">ACT_CalculatePositions</span><span class="p">();</span>
<span class="o">//</span><span class="n">ACT_BLOCK</span><span class="p">();</span>
<span class="n">ACT_RTDs</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>

<span class="n">ACTION</span> <span class="n">ACT_Init</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Instantiate</span> <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="nb">all</span> <span class="n">the</span> <span class="n">blades</span>
<span class="n">ACT_Motion</span><span class="p">();</span>
<span class="o">//</span><span class="n">SET</span> <span class="ow">and</span> <span class="n">GET</span> <span class="n">the</span> <span class="n">requested</span> <span class="ow">and</span> <span class="n">Actual</span> <span class="n">values</span>
<span class="n">ACT_CalculatePositions</span><span class="p">();</span>
<span class="o">//</span><span class="n">ACT_BLOCK</span><span class="p">();</span>
<span class="n">ACT_RTDs</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">ACTION</span> <span class="n">ACT_RTDs</span><span class="p">:</span>
<span class="o">//</span> <span class="n">Database</span>
<span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">sPmpsState</span><span class="p">;</span>
<span class="n">fbReadPMPSDB</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">NOT</span> <span class="n">MOTION_GVL</span><span class="o">.</span><span class="n">fbPmpsFileReader</span><span class="o">.</span><span class="n">bBusy</span><span class="p">,</span>
    <span class="n">jsonDoc</span><span class="o">:=</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">BP_jsonDoc</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">arrStates</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span><span class="n">RTDs</span>
<span class="n">RTD_TOP_1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_TOP_2</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_Bottom_1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_Bottom_2</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_North_1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_North_2</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_South_1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">RTD_South_2</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">astTempDb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">i_DevName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">io_fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>

<span class="o">//</span><span class="n">Flow</span> <span class="n">Switch</span>
<span class="n">fbFlowSwitch</span><span class="p">();</span>
<span class="n">END_ACTION</span>

<span class="n">METHOD</span> <span class="n">M_UpdatePMPS</span> <span class="p">:</span> <span class="n">BOOL</span>
<span class="n">VAR_INPUT</span>
    <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span><span class="n">Keep</span> <span class="n">updating</span> <span class="n">the</span> <span class="n">status</span> <span class="n">of</span> <span class="n">the</span> <span class="n">apertures</span> <span class="n">PMPS</span>
<span class="n">This</span><span class="o">^.</span><span class="n">AptArrayStatus</span><span class="o">.</span><span class="n">Height</span> <span class="o">:=</span> <span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeY</span><span class="p">;</span>
<span class="n">This</span><span class="o">^.</span><span class="n">AptArrayStatus</span><span class="o">.</span><span class="n">Width</span> <span class="o">:=</span> <span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeX</span><span class="p">;</span>
<span class="n">This</span><span class="o">^.</span><span class="n">AptArrayStatus</span><span class="o">.</span><span class="n">xOK</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">stTopBlade</span><span class="o">.</span><span class="n">bError</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">stBottomBlade</span><span class="o">.</span><span class="n">bError</span><span class="p">)</span>
                                 <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">stNorthBlade</span><span class="o">.</span><span class="n">bError</span><span class="p">)</span> <span class="n">AND</span> <span class="n">NOT</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">stNorthBlade</span><span class="o">.</span><span class="n">bError</span><span class="p">);</span>

<span class="o">//</span><span class="n">Evaluate</span> <span class="n">that</span> <span class="n">the</span> <span class="n">current</span> <span class="n">center</span> <span class="n">on</span> <span class="n">the</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">y</span> <span class="n">direction</span> <span class="n">didn</span><span class="s1">&#39;t exceed limits,</span>
<span class="o">//</span> <span class="n">Gap</span> <span class="n">should</span> <span class="n">be</span> <span class="n">reduced</span> <span class="n">when</span> <span class="n">center</span> <span class="ow">is</span> <span class="n">moved</span><span class="p">,</span> <span class="n">gap</span> <span class="o">&lt;</span> <span class="n">Maximum</span> <span class="n">permessible</span> <span class="n">gap</span> <span class="o">-</span> <span class="mi">2</span><span class="o">|</span><span class="n">Center</span> <span class="n">deviation</span> <span class="kn">from</span> <span class="nn">nominal</span><span class="o">|</span>
<span class="o">//</span><span class="n">Fast</span> <span class="n">fault</span> <span class="n">when</span> <span class="n">it</span> <span class="n">does</span><span class="o">.</span>
<span class="n">IF</span><span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeX</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Width</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ABS</span><span class="p">(</span><span class="n">rActCenterX</span><span class="p">)))</span>
<span class="o">//</span><span class="p">(</span><span class="n">rActCenterX</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">AND</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Width</span> <span class="o">&gt;</span><span class="mi">0</span> <span class="p">))</span>
    <span class="n">OR</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeY</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Height</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">ABS</span><span class="p">(</span><span class="n">rActCenterY</span><span class="p">)))</span>
    <span class="o">//</span><span class="p">((</span><span class="n">rActCenterY</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">AND</span><span class="p">(</span><span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">stCurrentBeamParameters</span><span class="o">.</span><span class="n">astApertures</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">Height</span><span class="o">&gt;</span><span class="mi">0</span> <span class="p">))</span> <span class="n">THEN</span>
        <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">ELSE</span>
        <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span><span class="n">Evaluate</span> <span class="n">that</span> <span class="n">the</span> <span class="n">requested</span> <span class="n">gaps</span> <span class="n">on</span> <span class="n">the</span> <span class="n">X</span> <span class="ow">and</span> <span class="n">the</span> <span class="n">y</span> <span class="n">direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">larger</span> <span class="n">than</span> <span class="n">the</span> <span class="n">current</span> <span class="n">gap</span>
<span class="o">//</span> <span class="n">narrow</span>  <span class="n">the</span> <span class="n">gap</span> <span class="k">if</span> <span class="n">the</span> <span class="n">requested</span> <span class="ow">is</span> <span class="n">larger</span>
<span class="n">IF</span><span class="p">(</span><span class="n">xPMPSMode</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeX</span> <span class="o">&gt;</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Width</span><span class="p">)</span> <span class="n">THEN</span>
        <span class="n">rReqApertureSizeX</span> <span class="o">:=</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Width</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">IF</span> <span class="p">(</span><span class="n">This</span><span class="o">^.</span><span class="n">rActApertureSizeY</span> <span class="o">&gt;</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Height</span><span class="p">)</span> <span class="n">THEN</span>
         <span class="n">rReqApertureSizeY</span> <span class="o">:=</span> <span class="n">AptArrayReq</span><span class="o">.</span><span class="n">Height</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">;</span>
    <span class="n">END_IF</span>
    <span class="n">ELSE</span>
     <span class="n">FFO</span><span class="o">.</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_IF</span>


<span class="p">(</span><span class="o">*</span><span class="n">FAST</span> <span class="n">FAULT</span><span class="o">*</span><span class="p">)</span>
<span class="n">FFO</span><span class="p">(</span><span class="n">i_xOK</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xReset</span> <span class="o">:=</span> <span class="p">,</span>
    <span class="n">i_xAutoReset</span> <span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span> <span class="o">:=</span> <span class="n">io_fbFFHWO</span><span class="p">);</span>
<span class="n">END_METHOD</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
<li><p><a class="reference internal" href="#fb-slits">FB_SLITS</a></p></li>
<li><p><a class="reference internal" href="#fb-xtes-flowswitch">FB_XTES_Flowswitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-slits-powertest">
<h2>FB_SLITS_POWERTest<a class="headerlink" href="#fb-slits-powertest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_SLITS_POWERTest EXTENDS FB_TestSuite
VAR
    fbSlitsPower: FB_SLITS_POWER;
    M1: ST_MotionStage;
    M2: ST_MotionStage;
    M3: ST_MotionStage;
    M4: ST_MotionStage;
    bExecuteMotion: BOOL := FALSE;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
END_VAR
fbSlitsPower(
    stTopBlade:=M1,
    stBottomBlade:=M2,
    stNorthBlade:=M3,
    stSouthBlade:=M4,
    bExecuteMotion:=bExecuteMotion,
    i_DevName:=&#39;DEVICE&#39;,
    sPmpsState:=&#39;T1&#39;,
    io_fbFFHWO := fbFFHWO,
    fbArbiter := fbArbiter,
);

TestTempFFO();

END_FUNCTION_BLOCK

METHOD AssertAllTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertFalse(
    fbSlitsPower.RTD_TOP_1.FFO.i_xOK,
    CONCAT(&#39;Slits Top 1 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_TOP_2.FFO.i_xOK,
    CONCAT(&#39;Slits Top 2 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_Bottom_1.FFO.i_xOK,
    CONCAT(&#39;Slits Bottom 1 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_Bottom_2.FFO.i_xOK,
    CONCAT(&#39;Slits Bottom 2 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_North_1.FFO.i_xOK,
    CONCAT(&#39;Slits North 1 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_North_2.FFO.i_xOK,
    CONCAT(&#39;Slits North 2 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_South_1.FFO.i_xOK,
    CONCAT(&#39;Slits South 1 RTD expected fault: &#39;, Message),
);
AssertFalse(
    fbSlitsPower.RTD_South_2.FFO.i_xOK,
    CONCAT(&#39;Slits South 2 1 RTD expected fault: &#39;, Message),
);
END_METHOD

METHOD AssertNoneTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertTrue(
    fbSlitsPower.RTD_TOP_1.FFO.i_xOK,
    CONCAT(&#39;Slits Top 1 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_TOP_2.FFO.i_xOK,
    CONCAT(&#39;Slits Top 2 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_Bottom_1.FFO.i_xOK,
    CONCAT(&#39;Slits Bottom 1 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_Bottom_2.FFO.i_xOK,
    CONCAT(&#39;Slits Bottom 2 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_North_1.FFO.i_xOK,
    CONCAT(&#39;Slits North 1 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_North_2.FFO.i_xOK,
    CONCAT(&#39;Slits North 2 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_South_1.FFO.i_xOK,
    CONCAT(&#39;Slits South 1 RTD expected ok: &#39;, Message),
);
AssertTrue(
    fbSlitsPower.RTD_South_2.FFO.i_xOK,
    CONCAT(&#39;Slits South 2 1 RTD expected ok: &#39;, Message),
);
END_METHOD

METHOD SetSlitsTemp
VAR_INPUT
    iTempC: INT;
END_VAR
VAR
    ptr: POINTER TO INT;
END_VAR
ptr := ADR(fbSlitsPower.RTD_TOP_1.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_TOP_2.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_Bottom_1.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_Bottom_2.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_North_1.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_North_2.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_South_1.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbSlitsPower.RTD_South_2.iRaw);
ptr^ := iTempC * 10;
END_METHOD

METHOD TestTempFFO
VAR_INST
    tonTimer: TON;
    nStep: UINT := 0;
END_VAR
VAR CONSTANT
    nLastStep: UINT := 4;
END_VAR
// Do we fault at the correct times?
TEST(&#39;TestSlitsTempFFO&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);


CASE nStep OF
    0:
        // Hold until the PMPS DB is ready
        // Most tests don&#39;t need this because they start by waiting for a move
        IF fbSlitsPower.RTD_TOP_1.fFaultThreshold &gt; 0 THEN
            nStep := nStep + 1;
        END_IF
    1:
        // Set the thermocouple temperatures to crazy high number
        SetSlitsTemp(100);
        nStep := nStep + 1;
    2:
        // We should see faults on all RTDs at 100C
        AssertAllTempFault(&#39;has high temp reading&#39;);
        nStep := nStep + 1;
    3:
        // Set the thermocouple temperatures to low again
        SetSlitsTemp(0);
        nStep := nStep + 1;
    4:
        AssertNoneTempFault(&#39;has low temp reading&#39;);
        nStep := nStep + 1;
END_CASE;

IF tonTimer.Q OR nStep &gt; nLastStep THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in PPM temp FFO test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-slits-power">FB_SLITS_POWER</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-sxr-satt-stage">
<h2>FB_SXR_SATT_Stage<a class="headerlink" href="#fb-sxr-satt-stage" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_SXR_SATT_Stage
(*
    Function block for a single Solid ATTenuator (SATT) filter stack.
    This is for the L2SI compact design with 4 filter stacks that each have
    many filters.

    This function block controls:
    - Y motion
    - Y filter states
    - transmission calculation for one stack

    There will be a fast fault during motion, but no other PMPS restrictions.
*)
VAR_IN_OUT
    // Y motor (filter select)
    stAxis : ST_MotionStage;
    // The fast fault output to fault to.
    fbFFHWO: FB_HardwareFFOutput;
END_VAR
VAR_INPUT
    // Settings for the OUT state.
    stOut           : ST_PositionState;
    // Settings for the FILTER1 state.
    stFilter1       : ST_PositionState;
    // Settings for the FILTER2 state.
    stFilter2       : ST_PositionState;
    // Settings for the FILTER3 state.
    stFilter3       : ST_PositionState;
    // Settings for the FILTER4 state.
    stFilter4       : ST_PositionState;
    // Settings for the FILTER5 state.
    stFilter5       : ST_PositionState;
    // Settings for the FILTER6 state.
    stFilter6       : ST_PositionState;
    // Settings for the FILTER7 state.
    stFilter7       : ST_PositionState;
    // Settings for the FILTER8 state.
    stFilter8       : ST_PositionState;

    // Set this to a non-unknown value to request a new move.
    {attribute &#39;pytmc&#39; := &#39;
        pv: STATE:SET
        io: io
    &#39;}
    eEnumSet: E_SXR_SATT_Position;
    // Set this to TRUE to enable input state moves, or FALSE to disable them.
    bEnable: BOOL;

    // Filter configuration information
    {attribute &#39;pytmc&#39; := &#39;pv: FILTERS&#39;}
    arrFilters: ARRAY[1..8] OF ST_SATT_Filter;

    // String name from PMPS database
    sDeviceName: STRING;

    // Debug helper for setting the stage&#39;s nEnableMode
    nEnableMode : E_StageEnableMode;
END_VAR
VAR_OUTPUT
    // The current position state as an enum.
    {attribute &#39;pytmc&#39; := &#39;
        pv: STATE:GET
        io: i
    &#39;}
    eEnumGet: E_SXR_SATT_Position;

    fTemp1 : LREAL;
    fTemp2 : LREAL;
    bIsStationary : BOOL;
    bError : BOOL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: MATERIAL
        io: i
    &#39;}
    sActiveFilterMaterial : STRING;

    {attribute &#39;pytmc&#39; := &#39;
        pv: THICKNESS
        io: i
        field: EGU um
    &#39;}
    fActiveFilterThickness_um : LREAL;

    {attribute &#39;pytmc&#39; := &#39;
        pv: TRANSMISSION
        io: i
        field: DESC Filter transmission
    &#39;}
    fTransmission : LREAL;
    fActiveFilterDensity : LREAL;
    fActiveFilterAtomicMass : LREAL;
    fAbsorptionConstant : LREAL;

    iFilterIndex: INT := 0;
END_VAR
VAR
    fbMotion: FB_MotionStage;

    {attribute &#39;pytmc&#39; := &#39;
        pv:
        astPositionState.array: 1..9
    &#39;}
    fbStates: FB_PositionState1D;
    astPositionState: ARRAY[1..GeneralConstants.MAX_STATES] OF ST_PositionState;
    fbArrCheckWrite: FB_CheckPositionStateWrite;

    bInitialized: BOOL := FALSE;

    fbAtomicMass : FB_AtomicMass;
    fbAttenuatorElementDensity : FB_AttenuatorElementDensity;

    (* EL3202-0020: 0.01 °C per digit *)
    {attribute &#39;pytmc&#39; := &#39;pv: RTD:1&#39;}
    fbRTD_1: FB_CC_TempSensor := ( fResolution:=0.01 );
    {attribute &#39;pytmc&#39; := &#39;pv: RTD:2&#39;}
    fbRTD_2: FB_CC_TempSensor := ( fResolution:=0.01 );

    fbReadPMPSDB: FB_JsonDocToSafeBP;
    astPickedDB: ARRAY[1..1] OF ST_DbStateParams;

    fbFF: FB_FastFault := (i_Desc := &#39;Device is moving&#39;,
                           i_TypeCode := E_MotionFFType.DEVICE_MOVE,
                           i_xAutoReset := TRUE);
END_VAR
IF NOT bInitialized THEN
    bInitialized := TRUE;

    (* Defaults for ST_MotionStage *)
    stAxis.bHardwareEnable      := TRUE;
    stAxis.bLimitBackwardEnable := TRUE;
    stAxis.bLimitForwardEnable  := TRUE;
    stAxis.bPowerSelf           := TRUE;
    stAxis.nBrakeMode           := ENUM_StageBrakeMode.NO_BRAKE;
    stAxis.nHomingMode          := ENUM_EpicsHomeCmd.NONE;

    (* Defaults for visualization *)
    // stExtra.fVisuStep                    := 0.1;

END_IF

stAxis.nEnableMode := nEnableMode;
fbMotion(stMotionStage:=stAxis);

// We need to update from PLC or from EPICS, but not both
fbArrCheckWrite(
    astPositionState:=astPositionState,
    bCheck:=TRUE,
    bSave:=FALSE,
);
IF NOT fbArrCheckWrite.bHadWrite THEN
    astPositionState[E_SXR_SATT_Position.OUT] := stOut;
    astPositionState[E_SXR_SATT_Position.FILTER1] := stFilter1;
    astPositionState[E_SXR_SATT_Position.FILTER2] := stFilter2;
    astPositionState[E_SXR_SATT_Position.FILTER3] := stFilter3;
    astPositionState[E_SXR_SATT_Position.FILTER4] := stFilter4;
    astPositionState[E_SXR_SATT_Position.FILTER5] := stFilter5;
    astPositionState[E_SXR_SATT_Position.FILTER6] := stFilter6;
    astPositionState[E_SXR_SATT_Position.FILTER7] := stFilter7;
    astPositionState[E_SXR_SATT_Position.FILTER8] := stFilter8;
END_IF

fbStates(
    stMotionStage:=stAxis,
    astPositionState:=astPositionState,
    eEnumSet:=eEnumSet,
    eEnumGet:=eEnumGet,
    bEnable:=bEnable,
);

fbArrCheckWrite(
    astPositionState:=astPositionState,
    bCheck:=FALSE,
    bSave:=TRUE,
);

stOut := astPositionState[E_SXR_SATT_Position.OUT];
stFilter1 := astPositionState[E_SXR_SATT_Position.FILTER1];
stFilter2 := astPositionState[E_SXR_SATT_Position.FILTER2];
stFilter3 := astPositionState[E_SXR_SATT_Position.FILTER3];
stFilter4 := astPositionState[E_SXR_SATT_Position.FILTER4];
stFilter5 := astPositionState[E_SXR_SATT_Position.FILTER5];
stFilter6 := astPositionState[E_SXR_SATT_Position.FILTER6];
stFilter7 := astPositionState[E_SXR_SATT_Position.FILTER7];
stFilter8 := astPositionState[E_SXR_SATT_Position.FILTER8];

(* Filter indices are off by one due to &quot;Out&quot; being in position 1. *)
iFilterIndex := UINT_TO_INT(eEnumGet - 1);

IF iFilterIndex &gt;= 1 AND iFilterIndex &lt;= 8 THEN
    sActiveFilterMaterial := arrFilters[iFilterIndex].sFilterMaterial;
    fActiveFilterThickness_um := arrFilters[iFilterIndex].fFilterThickness_um;

    fbAtomicMass(sName:=sActiveFilterMaterial, fValue=&gt;fActiveFilterAtomicMass);
    fbAttenuatorElementDensity(sName:=sActiveFilterMaterial, fDensity=&gt;fActiveFilterDensity);

    fAbsorptionConstant := F_CalculateAbsorptionConstant(
        sElement:=sActiveFilterMaterial,
        fEnergyEV:=PMPS_GVL.stCurrentBeamParameters.neV,
        fDensity_gm3:=fActiveFilterDensity,
        fAtomicWeight:=fActiveFilterAtomicMass,
        bError=&gt;bError,
    );
    fTransmission := F_CalculateTransmission(
        fAbsorptionConstant:=fAbsorptionConstant,
        fThickness_in_m:=fActiveFilterThickness_um * 1.0E-6
    );
ELSE
    sActiveFilterMaterial := &#39;&#39;;
    fActiveFilterThickness_um := 0.0;
    fAbsorptionConstant := 0.0;
    fActiveFilterDensity := 0.0;
    fActiveFilterAtomicMass := 0.0;
    fTransmission := 1.0;
END_IF

bIsStationary := NOT stAxis.Axis.Status.Moving;
fbFF(
    i_DevName:=sDeviceName,
    i_xOK:=bIsStationary AND eEnumGet &lt;&gt; E_SXR_SATT_Position.UNKNOWN,
    io_fbFFHWO := fbFFHWO
);

// There will be a single state provided on one of the filters for reactive temp
// This database entry must exist, but the temperature can be blank
IF stFilter1.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter1.stPMPS.sPmpsState;
ELSIF stFilter2.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter2.stPMPS.sPmpsState;
ELSIF stFilter3.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter3.stPMPS.sPmpsState;
ELSIF stFilter4.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter4.stPMPS.sPmpsState;
ELSIF stFilter5.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter5.stPMPS.sPmpsState;
ELSIF stFilter6.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter6.stPMPS.sPmpsState;
ELSIF stFilter7.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter7.stPMPS.sPmpsState;
ELSIF stFilter8.stPMPS.sPmpsState &lt;&gt; &#39;&#39; THEN
    astPickedDB[1].sPmpsState := stFilter8.stPMPS.sPmpsState;
END_IF

IF sDeviceName = &#39;&#39; THEN
    sDeviceName := stAxis.sName;
END_IF

fbReadPMPSDB(
    bExecute:=NOT MOTION_GVL.fbPmpsFileReader.bBusy,
    jsonDoc:=PMPS_GVL.BP_jsonDoc,
    sDeviceName:=sDeviceName,
    arrStates:=astPickedDB,
    io_fbFFHWO:=fbFFHWO,
);

fbRTD_1(
    fFaultThreshold:=astPickedDB[1].stReactiveParams.nTempSP,
    sDevName:=sDeviceName,
    bVeto:=eEnumGet = E_SXR_SATT_Position.OUT,
    io_fbFFHWO:=fbFFHWO,
);
fTemp1 := fbRTD_1.fTemp;

fbRTD_2(
    fFaultThreshold:=astPickedDB[1].stReactiveParams.nTempSP,
    sDevName:=sDeviceName,
    bVeto:=eEnumGet = E_SXR_SATT_Position.OUT,
    io_fbFFHWO:=fbFFHWO,
);
fTemp2 := fbRTD_2.fTemp;

END_FUNCTION_BLOCK
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-sxr-satt-position">E_SXR_SATT_Position</a></p></li>
<li><p><a class="reference internal" href="#fb-attenuatorelementdensity">FB_AttenuatorElementDensity</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#st-satt-filter">ST_SATT_Filter</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-wfs">
<h2>FB_WFS<a class="headerlink" href="#fb-wfs" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_WFS</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">WaveFront</span> <span class="n">Sensor</span> <span class="n">target</span> <span class="p">(</span><span class="n">WFS</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">X</span><span class="p">,</span> <span class="n">Z</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">target</span> <span class="n">states</span>
    <span class="o">-</span> <span class="mi">2</span> <span class="n">thermocouples</span>

    <span class="n">The</span> <span class="n">following</span> <span class="n">IO</span> <span class="n">link</span> <span class="n">points</span> <span class="n">are</span> <span class="n">included</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_WFS</span><span class="o">.</span><span class="n">fbThermoCouple1</span><span class="o">.</span><span class="n">fbThermoCouple</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="n">bUnderrange</span><span class="p">,</span> <span class="n">bOverrange</span><span class="p">,</span> <span class="ow">and</span> <span class="n">iRaw</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">thermocouple</span> <span class="n">terminal</span> <span class="n">inputs</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_WFS</span><span class="o">.</span><span class="n">fbThermoCouple1</span><span class="o">.</span><span class="n">fbThermoCouple</span><span class="o">.</span><span class="n">bError</span><span class="p">,</span> <span class="n">bUnderrange</span><span class="p">,</span> <span class="n">bOverrange</span><span class="p">,</span> <span class="ow">and</span> <span class="n">iRaw</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">corresponding</span> <span class="n">thermocouple</span> <span class="n">terminal</span> <span class="n">inputs</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Z</span> <span class="n">motor</span> <span class="p">(</span><span class="n">focus</span> <span class="n">adjust</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stZStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET1</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget1</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET2</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget2</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET3</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget3</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET4</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget4</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">TARGET5</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stTarget5</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_WFS_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_WFS_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbZStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..6</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STC:01&#39;</span><span class="p">}</span>
    <span class="n">fbThermoCouple1</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: STC:02&#39;</span><span class="p">}</span>
    <span class="n">fbThermoCouple2</span><span class="p">:</span> <span class="n">FB_CC_TempSensor</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: FSW&#39;</span><span class="p">}</span>
    <span class="n">fbFlowSwitch</span><span class="p">:</span> <span class="n">FB_XTES_Flowswitch</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span><span class="s1">&#39;pv: FWM&#39;</span><span class="p">}</span>
    <span class="n">fbFlowMeter</span><span class="p">:</span> <span class="n">FB_AnalogInput</span> <span class="o">:=</span> <span class="p">(</span><span class="n">iTermBits</span><span class="o">:=</span><span class="mi">15</span><span class="p">,</span> <span class="n">fTermMax</span><span class="o">:=</span><span class="mi">60</span><span class="p">,</span> <span class="n">fTermMin</span><span class="o">:=</span><span class="mi">0</span><span class="p">);</span>

<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">State</span> <span class="n">defaults</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">provided</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">fOutDecel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stZStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fOutDecel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget1</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET1&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget2</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET2&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget3</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET3&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget4</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET4&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stTarget5</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;TARGET5&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>

<span class="n">stZStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stZStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stZStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stZStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>
<span class="n">fbZStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stZStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget1</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget2</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET3</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget3</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET4</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget4</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET5</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stTarget5</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stTarget1</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET1</span><span class="p">];</span>
<span class="n">stTarget2</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET2</span><span class="p">];</span>
<span class="n">stTarget3</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET3</span><span class="p">];</span>
<span class="n">stTarget4</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET4</span><span class="p">];</span>
<span class="n">stTarget5</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_WFS_States</span><span class="o">.</span><span class="n">TARGET5</span><span class="p">];</span>

<span class="n">fbThermoCouple1</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">fbStates</span><span class="o">.</span><span class="n">stDbStateParams</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">bVeto</span><span class="o">:=</span><span class="n">eEnumGet</span> <span class="o">=</span> <span class="n">E_WFS_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbThermoCouple2</span><span class="p">(</span>
    <span class="n">fFaultThreshold</span><span class="o">:=</span><span class="n">fbStates</span><span class="o">.</span><span class="n">stDbStateParams</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span><span class="p">,</span>
    <span class="n">bVeto</span><span class="o">:=</span><span class="n">eEnumGet</span> <span class="o">=</span> <span class="n">E_WFS_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">,</span>
    <span class="n">sDevName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">io_fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">fbFlowSwitch</span><span class="p">();</span> <span class="o">//</span> <span class="n">WFS</span> <span class="ow">in</span> <span class="n">FEE</span>
<span class="n">fbFlowMeter</span><span class="p">();</span> <span class="o">//</span> <span class="n">WFS</span> <span class="ow">in</span> <span class="n">hutch</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-wfs-states">E_WFS_States</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensor">FB_CC_TempSensor</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
<li><p><a class="reference internal" href="#fb-xtes-flowswitch">FB_XTES_Flowswitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-wfstest">
<h2>FB_WFSTest<a class="headerlink" href="#fb-wfstest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_WFSTest EXTENDS FB_TestSuite
VAR
    fbWFS: FB_WFS;
    stYStage: ST_MotionStage;
    stZStage: ST_MotionStage;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbWFS.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbWFS.stTarget1, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbWFS.stTarget2, sName:=&#39;T2&#39;, fPosition:=30, sPmpsState:=&#39;T2&#39;);
fbSetup(stPositionState:=fbWFS.stTarget3, sName:=&#39;T3&#39;, fPosition:=40, sPmpsState:=&#39;T3&#39;);
fbSetup(stPositionState:=fbWFS.stTarget4, sName:=&#39;T4&#39;, fPosition:=50, sPmpsState:=&#39;T4&#39;);
fbSetup(stPositionState:=fbWFS.stTarget5, sName:=&#39;T5&#39;, fPosition:=60, sPmpsState:=&#39;T5&#39;);

// Standard FB call
fbWFS(
    stYStage:=stYStage,
    stZStage:=stZStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();
TestTempFFO();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD AssertBothTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertFalse(
    fbWFS.fbThermoCouple1.FFO.i_xOK,
    CONCAT(&#39;WFS TC1 expected fault: &#39;, Message),
);
AssertFalse(
    fbWFS.fbThermoCouple2.FFO.i_xOK,
    CONCAT(&#39;WFS TC2 expected fault: &#39;, Message),
);
END_METHOD

METHOD AssertNeitherTempFault
VAR_INPUT
    Message: STRING;
END_VAR
AssertTrue(
    fbWFS.fbThermoCouple1.FFO.i_xOK,
    CONCAT(&#39;WFS TC1 expected ok: &#39;, Message),
);
AssertTrue(
    fbWFS.fbThermoCouple1.FFO.i_xOK,
    CONCAT(&#39;WFS TC2 sensor expected ok: &#39;, Message),
);
END_METHOD

METHOD SetWFSTemp
VAR_INPUT
    iTempC: INT;
END_VAR
VAR
    ptr: POINTER TO INT;
END_VAR
ptr := ADR(fbWFS.fbThermoCouple1.iRaw);
ptr^ := iTempC * 10;

ptr := ADR(fbWFS.fbThermoCouple2.iRaw);
ptr^ := iTempC * 10;
END_METHOD

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_WFS_States.TARGET5;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestWFSStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbWFS.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbWFS.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in WFS move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD

METHOD TestTempFFO
VAR_INST
    tonTimer: TON;
    nStep: UINT := 0;
    bOutChecked: BOOL := FALSE;
    bInChecked: BOOL := FALSE;
END_VAR
VAR CONSTANT
    nLastStep: UINT := 3;
END_VAR
// Do we fault at the correct times?
// Parasitically depends on state move test
TEST(&#39;TestWFSTempFFO&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

CASE nStep OF
    0:
        // Set the thermocouple temperatures to crazy high number
        SetWFSTemp(100);
        nStep := nStep + 1;
    1:
        // Wait till we see &quot;OUT&quot; state and one other state (OUT should be no fault)
        IF fbWFS.eEnumGet = E_WFS_States.OUT THEN
            AssertNeitherTempFault(&#39;was in out position&#39;);
            bOutChecked := TRUE;
        ELSIF fbWFS.eEnumGet &lt;&gt; E_WFS_States.Unknown THEN
            AssertBothTempFault(&#39;was in a target position&#39;);
            bInChecked := TRUE;
        END_IF
        IF bOutChecked AND bInChecked THEN
            nStep := nStep + 1;
        END_IF
    2:
        // Set the thermocouple temperatures to low again
        SetWFSTemp(0);
        nStep := nStep + 1;
    3:
        AssertNeitherTempFault(&#39;has low temp reading&#39;);
        nStep := nStep + 1;
END_CASE;

IF tonTimer.Q OR nStep &gt; nLastStep THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in WFS temp FFO test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-wfs-states">E_WFS_States</a></p></li>
<li><p><a class="reference internal" href="#fb-wfs">FB_WFS</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xpim">
<h2>FB_XPIM<a class="headerlink" href="#fb-xpim" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XPIM</span>
<span class="p">(</span><span class="o">*</span>
    <span class="n">Function</span> <span class="n">block</span> <span class="k">for</span> <span class="n">XTES</span> <span class="n">Imager</span> <span class="p">(</span><span class="n">XPIM</span> <span class="o">=</span> <span class="n">XTES</span> <span class="n">PIM</span> <span class="o">=</span> <span class="n">Profile</span> <span class="n">Impager</span><span class="p">)</span> <span class="n">controls</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Zoom</span><span class="p">,</span> <span class="n">Focus</span> <span class="n">motion</span>
    <span class="o">-</span> <span class="n">Y</span> <span class="n">scintillator</span> <span class="n">states</span>
    <span class="o">-</span> <span class="n">filterwheel</span> <span class="n">serial</span> <span class="n">commands</span>
    <span class="o">-</span> <span class="n">camera</span> <span class="n">power</span>
    <span class="o">-</span> <span class="n">LED</span> <span class="n">on</span><span class="o">/</span><span class="n">off</span>
    <span class="o">-</span> <span class="n">flowswitch</span> <span class="p">(</span><span class="ow">not</span> <span class="n">fully</span> <span class="n">implemented</span><span class="p">)</span>

    <span class="n">The</span> <span class="n">following</span> <span class="n">IO</span> <span class="n">link</span> <span class="n">points</span> <span class="n">are</span> <span class="n">included</span> <span class="ow">and</span> <span class="n">should</span> <span class="n">be</span> <span class="n">used</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">bZoomEndFwd</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">zoom</span> <span class="n">motor</span><span class="s1">&#39;s forward limit switch.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">bZoomEndBwd</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">zoom</span> <span class="n">motor</span><span class="s1">&#39;s backward limit switch.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">bFocusEndFwd</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">focus</span> <span class="n">motor</span><span class="s1">&#39;s forward limit switch.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">bFocusEndBwd</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">focus</span> <span class="n">motor</span><span class="s1">&#39;s backward limit switch.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">fbOpal</span><span class="o">.</span><span class="n">bOpalPower</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">camera</span> <span class="n">power</span> <span class="n">digital</span> <span class="n">output</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">fbLED</span><span class="o">.</span><span class="n">bLEDPower</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">power</span> <span class="n">digital</span> <span class="n">output</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">FB_XPIM</span><span class="o">.</span><span class="n">fbFlowSwitch</span><span class="o">.</span><span class="n">bFlowOk</span> <span class="n">should</span> <span class="n">be</span> <span class="n">linked</span> <span class="n">to</span> <span class="n">the</span> <span class="n">flow</span> <span class="n">switch</span> <span class="n">digital</span> <span class="nb">input</span><span class="p">,</span> <span class="k">if</span> <span class="n">present</span><span class="o">.</span>
<span class="o">*</span><span class="p">)</span>
<span class="n">VAR_IN_OUT</span>
    <span class="o">//</span> <span class="n">Y</span> <span class="n">motor</span> <span class="p">(</span><span class="n">state</span> <span class="n">select</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stYStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Zoom</span> <span class="n">motor</span> <span class="p">(</span><span class="n">camera</span> <span class="n">zoom</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stZoomStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Focus</span> <span class="n">motor</span> <span class="p">(</span><span class="n">camera</span> <span class="n">focus</span><span class="p">)</span><span class="o">.</span>
    <span class="n">stFocusStage</span><span class="p">:</span> <span class="n">ST_MotionStage</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">fast</span> <span class="n">fault</span> <span class="n">output</span> <span class="n">to</span> <span class="n">fault</span> <span class="n">to</span><span class="o">.</span>
    <span class="n">fbFFHWO</span><span class="p">:</span> <span class="n">FB_HardwareFFOutput</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">arbiter</span> <span class="n">to</span> <span class="n">request</span> <span class="n">beam</span> <span class="n">conditions</span> <span class="n">from</span><span class="o">.</span>
    <span class="n">fbArbiter</span><span class="p">:</span> <span class="n">FB_Arbiter</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Serial</span> <span class="nb">input</span>
    <span class="n">stEl6In</span><span class="p">:</span> <span class="n">EL6inData22b</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Serial</span> <span class="n">output</span>
    <span class="n">stEl6Out</span><span class="p">:</span> <span class="n">EL6OutData22b</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_INPUT</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">OUT</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stOut</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">YAG</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stYag</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">DIAMOND</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDiamond</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Settings</span> <span class="k">for</span> <span class="n">the</span> <span class="n">RETICLE</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stReticle</span><span class="p">:</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">a</span> <span class="n">non</span><span class="o">-</span><span class="n">unknown</span> <span class="n">value</span> <span class="n">to</span> <span class="n">request</span> <span class="n">a</span> <span class="n">new</span> <span class="n">move</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumSet</span><span class="p">:</span> <span class="n">E_XPIM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="nb">input</span> <span class="n">state</span> <span class="n">moves</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableMotion</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">beam</span> <span class="n">parameter</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnableBeamParams</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">enable</span> <span class="n">position</span> <span class="n">limit</span> <span class="n">checks</span><span class="p">,</span> <span class="ow">or</span> <span class="n">FALSE</span> <span class="n">to</span> <span class="n">disable</span> <span class="n">them</span><span class="o">.</span>
    <span class="n">bEnablePositionLimits</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">device</span> <span class="k">for</span> <span class="n">use</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">DB</span> <span class="n">lookup</span> <span class="ow">and</span> <span class="n">diagnostic</span> <span class="n">screens</span><span class="o">.</span>
    <span class="n">sDeviceName</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="n">transition</span> <span class="n">state</span> <span class="ow">in</span> <span class="n">the</span> <span class="n">PMPS</span> <span class="n">database</span><span class="o">.</span>
    <span class="n">sTransitionKey</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Set</span> <span class="n">this</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="n">to</span> <span class="n">re</span><span class="o">-</span><span class="n">read</span> <span class="n">the</span> <span class="n">loaded</span> <span class="n">database</span> <span class="n">immediately</span> <span class="p">(</span><span class="n">useful</span> <span class="k">for</span> <span class="n">debug</span><span class="p">)</span><span class="o">.</span>
    <span class="n">bReadDBNow</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">While</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">zoom</span> <span class="n">motor</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">moved</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CLZ</span><span class="p">:</span><span class="n">LOCK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Unlocked</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Locked</span>
    <span class="s1">&#39;}</span>
    <span class="n">bZoomLock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">While</span> <span class="n">TRUE</span><span class="p">,</span> <span class="n">the</span> <span class="n">focus</span> <span class="n">motor</span> <span class="n">cannot</span> <span class="n">be</span> <span class="n">moved</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CLF</span><span class="p">:</span><span class="n">LOCK</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">Unlocked</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">Locked</span>
    <span class="s1">&#39;}</span>
    <span class="n">bFocusLock</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Forward</span> <span class="n">limit</span> <span class="n">disable</span> <span class="k">for</span> <span class="n">zoom</span>
    <span class="n">bZoomEndFwd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">limit</span> <span class="n">disable</span> <span class="k">for</span> <span class="n">zoom</span>
    <span class="n">bZoomEndBwd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Forward</span> <span class="n">limit</span> <span class="n">disable</span> <span class="k">for</span> <span class="n">focus</span>
    <span class="n">bFocusEndFwd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Backward</span> <span class="n">limit</span> <span class="n">disable</span> <span class="k">for</span> <span class="n">focus</span>
    <span class="n">bFocusEndBwd</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span> <span class="k">as</span> <span class="n">an</span> <span class="n">enum</span><span class="o">.</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span><span class="p">:</span><span class="n">STATE</span><span class="p">:</span><span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">eEnumGet</span><span class="p">:</span> <span class="n">E_XPIM_States</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">The</span> <span class="n">PMPS</span> <span class="n">database</span> <span class="n">lookup</span> <span class="n">associated</span> <span class="k">with</span> <span class="n">the</span> <span class="n">current</span> <span class="n">position</span> <span class="n">state</span><span class="o">.</span>
    <span class="n">stDbStateParams</span><span class="p">:</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bInit</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="n">fbYStage</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbZoom</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>
    <span class="n">fbFocus</span><span class="p">:</span> <span class="n">FB_MotionStage</span><span class="p">;</span>

    <span class="n">fbStateDefaults</span><span class="p">:</span> <span class="n">FB_PositionState_Defaults</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">MMS</span>
        <span class="n">astPositionState</span><span class="o">.</span><span class="n">array</span><span class="p">:</span> <span class="mf">1..4</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbStates</span><span class="p">:</span> <span class="n">FB_PositionStatePMPS1D</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">1.</span><span class="o">.</span><span class="n">GeneralConstants</span><span class="o">.</span><span class="n">MAX_STATES</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_PositionState</span><span class="p">;</span>
    <span class="n">fbArrCheckWrite</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWrite</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: MFW&#39;</span><span class="p">}</span>
    <span class="n">fbFilterWheel</span><span class="p">:</span> <span class="n">FB_XPIM_FilterWheel</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: CAM&#39;</span><span class="p">}</span>
    <span class="n">fbOpal</span><span class="p">:</span> <span class="n">FB_XPIM_Opal</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: CIL&#39;</span><span class="p">}</span>
    <span class="n">fbLED</span><span class="p">:</span> <span class="n">FB_XPIM_LED</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;pv: FSW&#39;</span><span class="p">}</span>
    <span class="n">fbFlowSwitch</span><span class="p">:</span> <span class="n">FB_XTES_Flowswitch</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span> <span class="n">CONSTANT</span>
    <span class="o">//</span> <span class="n">State</span> <span class="n">defaults</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">provided</span>
    <span class="n">fDelta</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">fAccel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">200</span><span class="p">;</span>
    <span class="n">fOutDecel</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">25</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bInit</span> <span class="n">THEN</span>
    <span class="n">bInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="n">stYStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stZoomStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>
    <span class="n">stFocusStage</span><span class="o">.</span><span class="n">nEnableMode</span> <span class="o">:=</span> <span class="n">ENUM_StageEnableMode</span><span class="o">.</span><span class="n">DURING_MOTION</span><span class="p">;</span>

    <span class="o">//</span> <span class="n">Partial</span> <span class="n">backcompat</span><span class="p">,</span> <span class="n">this</span> <span class="n">used</span> <span class="n">to</span> <span class="nb">set</span> <span class="n">fVelocity</span> <span class="n">too</span> <span class="n">but</span> <span class="n">this</span> <span class="n">should</span> <span class="n">be</span> <span class="nb">set</span> <span class="n">per</span> <span class="n">install</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stOut</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;OUT&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fOutDecel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stYag</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;YAG&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stDiamond</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;DIAMOND&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
    <span class="n">fbStateDefaults</span><span class="p">(</span><span class="n">stPositionState</span><span class="o">:=</span><span class="n">stReticle</span><span class="p">,</span> <span class="n">sNameDefault</span><span class="o">:=</span><span class="s1">&#39;RETICLE&#39;</span><span class="p">,</span> <span class="n">fDeltaDefault</span><span class="o">:=</span><span class="n">fDelta</span><span class="p">,</span> <span class="n">fAccelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">,</span> <span class="n">fDecelDefault</span><span class="o">:=</span><span class="n">fAccel</span><span class="p">);</span>
<span class="n">END_IF</span>

<span class="n">stYStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="o">//</span> <span class="n">No</span> <span class="n">limit</span> <span class="n">switch</span> <span class="n">at</span> <span class="n">the</span> <span class="n">bottom</span>
<span class="n">stYStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

<span class="o">//</span> <span class="n">Extra</span> <span class="n">lock</span> <span class="n">on</span> <span class="n">lens</span> <span class="o">+</span> <span class="n">lens</span> <span class="n">limits</span> <span class="n">are</span> <span class="n">NO</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">NC</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bZoomLock</span><span class="p">;</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bZoomEndFwd</span><span class="p">;</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bZoomEndBwd</span><span class="p">;</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">nHomingMode</span> <span class="o">:=</span> <span class="n">ENUM_EpicsHomeCmd</span><span class="o">.</span><span class="n">LOW_LIMIT</span><span class="p">;</span>
<span class="n">stZoomStage</span><span class="o">.</span><span class="n">fHomePosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">stFocusStage</span><span class="o">.</span><span class="n">bHardwareEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bFocusLock</span><span class="p">;</span>
<span class="n">stFocusStage</span><span class="o">.</span><span class="n">bPowerSelf</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">stFocusStage</span><span class="o">.</span><span class="n">bLimitForwardEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bFocusEndFwd</span><span class="p">;</span>
<span class="n">stFocusStage</span><span class="o">.</span><span class="n">bLimitBackwardEnable</span> <span class="o">:=</span> <span class="n">NOT</span> <span class="n">bFocusEndBwd</span><span class="p">;</span>
<span class="n">stFocusStage</span><span class="o">.</span><span class="n">nHomingMode</span> <span class="o">:=</span> <span class="n">ENUM_EpicsHomeCmd</span><span class="o">.</span><span class="n">LOW_LIMIT</span><span class="p">;</span>
<span class="n">stFocusStage</span><span class="o">.</span><span class="n">fHomePosition</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">fbYStage</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">);</span>
<span class="n">fbZoom</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stZoomStage</span><span class="p">);</span>
<span class="n">fbFocus</span><span class="p">(</span><span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stFocusStage</span><span class="p">);</span>

<span class="o">//</span> <span class="n">Set</span> <span class="n">special</span> <span class="n">error</span> <span class="n">message</span> <span class="k">for</span> <span class="n">lens</span> <span class="n">lock</span>
<span class="n">IF</span> <span class="n">stZoomStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">bZoomLock</span> <span class="n">THEN</span>
    <span class="n">stZoomStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stZoomStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Zoom lens is locked!&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">IF</span> <span class="n">stFocusStage</span><span class="o">.</span><span class="n">bExecute</span> <span class="n">AND</span> <span class="n">bFocusLock</span> <span class="n">THEN</span>
    <span class="n">stFocusStage</span><span class="o">.</span><span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">stFocusStage</span><span class="o">.</span><span class="n">sCustomErrorMessage</span> <span class="o">:=</span> <span class="s1">&#39;Focus lens is locked!&#39;</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="o">//</span> <span class="n">We</span> <span class="n">need</span> <span class="n">to</span> <span class="n">update</span> <span class="kn">from</span> <span class="nn">PLC</span> <span class="ow">or</span> <span class="kn">from</span> <span class="nn">EPICS</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span>
<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
<span class="p">);</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbArrCheckWrite</span><span class="o">.</span><span class="n">bHadWrite</span> <span class="n">THEN</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stOut</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">YAG</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stYag</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">DIAMOND</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stDiamond</span><span class="p">;</span>
    <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">RETICLE</span><span class="p">]</span> <span class="o">:=</span> <span class="n">stReticle</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">fbStates</span><span class="p">(</span>
    <span class="n">stMotionStage</span><span class="o">:=</span><span class="n">stYStage</span><span class="p">,</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">eEnumSet</span><span class="o">:=</span><span class="n">eEnumSet</span><span class="p">,</span>
    <span class="n">eEnumGet</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">,</span>
    <span class="n">fbFFHWO</span><span class="o">:=</span><span class="n">fbFFHWO</span><span class="p">,</span>
    <span class="n">fbArbiter</span><span class="o">:=</span><span class="n">fbArbiter</span><span class="p">,</span>
    <span class="n">bEnableMotion</span><span class="o">:=</span><span class="n">bEnableMotion</span><span class="p">,</span>
    <span class="n">bEnableBeamParams</span><span class="o">:=</span><span class="n">bEnableBeamParams</span><span class="p">,</span>
    <span class="n">bEnablePositionLimits</span><span class="o">:=</span><span class="n">bEnablePositionLimits</span><span class="p">,</span>
    <span class="n">sDeviceName</span><span class="o">:=</span><span class="n">sDeviceName</span><span class="p">,</span>
    <span class="n">sTransitionKey</span><span class="o">:=</span><span class="n">sTransitionKey</span><span class="p">,</span>
    <span class="n">bReadDBNow</span><span class="o">:=</span><span class="n">bReadDBNow</span><span class="p">,</span>
    <span class="n">stDbStateParams</span><span class="o">=&gt;</span><span class="n">stDbStateParams</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbArrCheckWrite</span><span class="p">(</span>
    <span class="n">astPositionState</span><span class="o">:=</span><span class="n">astPositionState</span><span class="p">,</span>
    <span class="n">bCheck</span><span class="o">:=</span><span class="n">FALSE</span><span class="p">,</span>
    <span class="n">bSave</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">stOut</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">OUT</span><span class="p">];</span>
<span class="n">stYag</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">YAG</span><span class="p">];</span>
<span class="n">stDiamond</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">DIAMOND</span><span class="p">];</span>
<span class="n">stReticle</span> <span class="o">:=</span> <span class="n">astPositionState</span><span class="p">[</span><span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">RETICLE</span><span class="p">];</span>

<span class="n">fbFilterWheel</span><span class="p">(</span>
    <span class="n">bExecute</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
    <span class="n">stIn_El6</span><span class="o">:=</span><span class="n">stEl6In</span><span class="p">,</span>
    <span class="n">stOut_El6</span><span class="o">:=</span><span class="n">stEl6Out</span><span class="p">,</span>
<span class="p">);</span>

<span class="n">fbOpal</span><span class="p">();</span>
<span class="n">fbLED</span><span class="p">(</span><span class="n">enumXPIM</span><span class="o">:=</span><span class="n">eEnumGet</span><span class="p">);</span>
<span class="n">fbFlowSwitch</span><span class="p">();</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-xpim-states">E_XPIM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewrite">FB_CheckPositionStateWrite</a></p></li>
<li><p><a class="reference internal" href="#fb-positionstate-defaults">FB_PositionState_Defaults</a></p></li>
<li><p><a class="reference internal" href="#fb-xpim-filterwheel">FB_XPIM_FilterWheel</a></p></li>
<li><p><a class="reference internal" href="#fb-xpim-led">FB_XPIM_LED</a></p></li>
<li><p><a class="reference internal" href="#fb-xpim-opal">FB_XPIM_Opal</a></p></li>
<li><p><a class="reference internal" href="#fb-xtes-flowswitch">FB_XTES_Flowswitch</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xpim-filterwheel">
<h2>FB_XPIM_FilterWheel<a class="headerlink" href="#fb-xpim-filterwheel" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XPIM_FilterWheel</span>
<span class="n">VAR_INPUT</span>
    <span class="n">bExecute</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span><span class="p">:</span><span class="n">RESET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">output</span>
    <span class="s1">&#39;}</span>
    <span class="n">bResetError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">SET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">nSetPos</span><span class="p">:</span> <span class="n">E_XPIM_Filters</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">GET</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">i</span>
    <span class="s1">&#39;}</span>
    <span class="n">nGetPos</span><span class="p">:</span> <span class="n">E_XPIM_Filters</span><span class="p">;</span>
    <span class="n">bBusy</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">bError</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">sError</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">ERR</span><span class="p">:</span><span class="n">MSG</span>
        <span class="n">io</span><span class="p">:</span> <span class="nb">input</span>
    <span class="s1">&#39;}</span>
    <span class="n">sLastError</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
    <span class="n">sErrorTS</span><span class="p">:</span> <span class="n">STRING</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_IN_OUT</span>
    <span class="n">stIn_EL6</span><span class="p">:</span> <span class="n">EL6inData22B</span><span class="p">;</span>
    <span class="n">stOut_EL6</span><span class="p">:</span> <span class="n">EL6outData22B</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">RAW</span>
    <span class="s1">&#39;}</span>
    <span class="n">fbCom</span><span class="p">:</span> <span class="n">FB_EL6_COM</span><span class="p">;</span>

    <span class="n">nStep</span><span class="p">:</span> <span class="n">USINT</span><span class="p">;</span>
    <span class="n">bIsTest</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
    <span class="n">fbGetTime</span><span class="p">:</span> <span class="n">NT_GetTime</span><span class="p">;</span>
    <span class="n">bStopOnErr</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">fbCom</span><span class="o">.</span><span class="n">sSendSuffix</span> <span class="o">:=</span> <span class="s1">&#39;$R&#39;</span><span class="p">;</span>
<span class="n">fbCom</span><span class="o">.</span><span class="n">sRecvSuffix</span> <span class="o">:=</span> <span class="s1">&#39;$R&#39;</span><span class="p">;</span>

<span class="n">IF</span> <span class="n">bExecute</span> <span class="n">AND</span> <span class="n">nStep</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
    <span class="n">IF</span> <span class="n">bResetError</span> <span class="n">OR</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">THEN</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">ELSIF</span> <span class="n">NOT</span> <span class="n">bExecute</span> <span class="n">THEN</span>
    <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">END_IF</span>
<span class="n">CASE</span> <span class="n">nStep</span> <span class="n">OF</span>
    <span class="mi">0</span><span class="p">:</span>
        <span class="p">;</span> <span class="o">//</span> <span class="n">idle</span>
    <span class="mi">10</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Get</span> <span class="n">position</span>
        <span class="n">bIsTest</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">fbCom</span><span class="p">(</span><span class="n">sCmd</span><span class="o">:=</span><span class="s1">&#39;pos?&#39;</span><span class="p">,</span>
            <span class="n">bSend</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
            <span class="n">stIn_EL6</span><span class="o">:=</span><span class="n">stIn_EL6</span><span class="p">,</span>
            <span class="n">stOut_EL6</span><span class="o">:=</span><span class="n">stOut_EL6</span><span class="p">);</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
    <span class="mi">20</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">and</span> <span class="nb">set</span> <span class="n">variables</span>
        <span class="n">fbCom</span><span class="p">(</span><span class="n">stIn_EL6</span><span class="o">:=</span><span class="n">stIn_EL6</span><span class="p">,</span>
            <span class="n">stOut_EL6</span><span class="o">:=</span><span class="n">stOut_EL6</span><span class="p">);</span>
        <span class="n">IF</span> <span class="n">fbCom</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bError</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">sError</span> <span class="o">:=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="n">nGetPos</span> <span class="o">:=</span> <span class="n">STRING_TO_USINT</span><span class="p">(</span><span class="n">fbCom</span><span class="o">.</span><span class="n">sResponse</span><span class="p">);</span>
            <span class="n">nSetPos</span> <span class="o">:=</span> <span class="n">nGetPos</span><span class="p">;</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">IF</span> <span class="n">nGetPos</span> <span class="o">=</span> <span class="mi">0</span> <span class="n">THEN</span>
                <span class="n">sError</span> <span class="o">:=</span> <span class="s1">&#39;Filter wheel in invalid state&#39;</span><span class="p">;</span>
                <span class="n">bStopOnErr</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
                <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="mi">30</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">a</span> <span class="n">move</span> <span class="n">request</span>
        <span class="n">IF</span> <span class="n">nSetPos</span> <span class="o">&lt;&gt;</span> <span class="n">nGetPos</span> <span class="n">THEN</span>
            <span class="n">fbCom</span><span class="p">(</span><span class="n">sCmd</span><span class="o">:=</span><span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;pos=&#39;</span><span class="p">,</span> <span class="n">INT_TO_STRING</span><span class="p">(</span><span class="n">nSetPos</span><span class="p">)),</span>
                <span class="n">bSend</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">,</span>
                <span class="n">stIn_EL6</span><span class="o">:=</span><span class="n">stIn_EL6</span><span class="p">,</span>
                <span class="n">stOut_EL6</span><span class="o">:=</span><span class="n">stOut_EL6</span><span class="p">);</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">END_IF</span>
    <span class="mi">40</span><span class="p">:</span>
        <span class="n">fbCom</span><span class="p">(</span><span class="n">stIn_EL6</span><span class="o">:=</span><span class="n">stIn_EL6</span><span class="p">,</span>
            <span class="n">stOut_EL6</span><span class="o">:=</span><span class="n">stOut_EL6</span><span class="p">);</span>
        <span class="o">//</span> <span class="n">Wait</span> <span class="k">for</span> <span class="n">move</span> <span class="n">to</span> <span class="n">be</span> <span class="n">done</span>
        <span class="n">IF</span> <span class="n">fbCom</span><span class="o">.</span><span class="n">bDone</span> <span class="n">THEN</span>
            <span class="n">bBusy</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="o">//</span> <span class="n">Handle</span> <span class="n">setpoint</span> <span class="n">error</span>
            <span class="n">IF</span> <span class="n">fbCom</span><span class="o">.</span><span class="n">sResponse</span> <span class="o">=</span> <span class="s1">&#39;Command error CMD_ARG_INVALID$N$R&#39;</span> <span class="n">THEN</span>
                <span class="n">sError</span> <span class="o">:=</span> <span class="s1">&#39;Invalid set position&#39;</span><span class="p">;</span>
                <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
            <span class="n">END_IF</span>
        <span class="n">END_IF</span>
    <span class="mi">50</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Set</span> <span class="n">sError</span> <span class="ow">and</span> <span class="n">then</span> <span class="n">jump</span> <span class="n">here</span> <span class="k">for</span> <span class="n">standard</span> <span class="n">handling</span>
        <span class="n">sLastError</span> <span class="o">:=</span> <span class="n">sError</span><span class="p">;</span>
        <span class="n">bError</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
        <span class="n">fbGetTime</span><span class="p">(</span><span class="n">NETID</span><span class="o">:=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
            <span class="n">START</span><span class="o">:=</span><span class="n">TRUE</span><span class="p">);</span>
        <span class="n">nStep</span> <span class="o">:=</span> <span class="n">nStep</span> <span class="o">+</span> <span class="mi">10</span><span class="p">;</span>
    <span class="mi">60</span><span class="p">:</span>
        <span class="o">//</span> <span class="n">Error</span> <span class="n">handling</span> <span class="n">continued</span>
        <span class="n">fbGetTime</span><span class="p">();</span>
        <span class="n">IF</span> <span class="n">NOT</span> <span class="n">fbGetTime</span><span class="o">.</span><span class="n">BUSY</span> <span class="n">THEN</span>
            <span class="n">sErrorTS</span> <span class="o">:=</span> <span class="n">SYSTEMTIME_TO_STRING</span><span class="p">(</span><span class="n">fbGetTime</span><span class="o">.</span><span class="n">TIMESTR</span><span class="p">);</span>
            <span class="n">fbGetTime</span><span class="o">.</span><span class="n">START</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
            <span class="o">//</span> <span class="nb">set</span> <span class="n">bStopOnErr</span> <span class="n">to</span> <span class="n">TRUE</span> <span class="k">if</span> <span class="n">it</span> <span class="n">was</span> <span class="n">a</span> <span class="n">major</span> <span class="n">error</span>
            <span class="n">IF</span> <span class="n">bStopOnErr</span> <span class="n">THEN</span>
                <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span>
            <span class="n">ELSE</span>
                <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>
            <span class="n">END_IF</span>
            <span class="n">bStopOnErr</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
        <span class="n">END_IF</span>
<span class="n">END_CASE</span>
<span class="o">//</span> <span class="n">Check</span> <span class="k">for</span> <span class="n">inner</span> <span class="n">comms</span> <span class="n">errors</span><span class="p">,</span> <span class="n">report</span> <span class="n">to</span> <span class="n">EPICS</span> <span class="n">same</span> <span class="n">way</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bError</span> <span class="n">AND</span>
    <span class="p">(</span><span class="n">fbCom</span><span class="o">.</span><span class="n">eRecvErrorID</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span>
    <span class="n">OR</span> <span class="n">fbCom</span><span class="o">.</span><span class="n">eSendErrorID</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span>
    <span class="n">OR</span> <span class="n">fbCom</span><span class="o">.</span><span class="n">eRecvErrorID</span> <span class="o">&lt;&gt;</span> <span class="n">COMERROR_NOERROR</span><span class="p">)</span> <span class="n">THEN</span>
    <span class="n">sError</span> <span class="o">:=</span> <span class="s1">&#39;Serial Communication Error&#39;</span><span class="p">;</span>
    <span class="n">bStopOnErr</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">nStep</span> <span class="o">:=</span> <span class="mi">50</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-xpim-filters">E_XPIM_Filters</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xpim-led">
<h2>FB_XPIM_LED<a class="headerlink" href="#fb-xpim-led" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XPIM_LED</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PWR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span>
    <span class="s1">&#39;}</span>
    <span class="n">bLEDPower</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">AUTO</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
    <span class="s1">&#39;}</span>
    <span class="n">bLEDAuto</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>

    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CLK</span><span class="p">:</span><span class="n">TIMEOUT</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="nb">min</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLEDTimeOut</span><span class="p">:</span> <span class="n">LREAL</span> <span class="o">:=</span> <span class="mi">10</span><span class="p">;</span>

    <span class="n">enumXPIM</span><span class="p">:</span> <span class="n">E_XPIM_States</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">CLK</span><span class="p">:</span><span class="n">REMAINING</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">EGU</span> <span class="nb">min</span>
    <span class="s1">&#39;}</span>
    <span class="n">fLEDRemaining</span><span class="p">:</span> <span class="n">LREAL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">tonLED</span><span class="p">:</span> <span class="n">TON</span><span class="p">;</span>
    <span class="n">enumLastCycle</span><span class="p">:</span> <span class="n">E_XPIM_States</span> <span class="o">:=</span> <span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">Unknown</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">If</span> <span class="n">configured</span><span class="p">,</span> <span class="n">change</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">level</span> <span class="n">automatically</span>
<span class="o">//</span> <span class="n">LED</span> <span class="ow">is</span> <span class="n">always</span> <span class="p">(</span><span class="ow">and</span> <span class="n">only</span><span class="p">)</span> <span class="n">useful</span> <span class="n">at</span> <span class="n">Reticle</span> <span class="n">state</span>
<span class="n">IF</span> <span class="n">bLEDAuto</span> <span class="n">AND</span> <span class="n">enumXPIM</span> <span class="o">&lt;&gt;</span> <span class="n">enumLastCycle</span> <span class="n">THEN</span>
    <span class="o">//</span> <span class="n">Turn</span> <span class="n">on</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">when</span> <span class="n">we</span> <span class="n">get</span> <span class="n">to</span> <span class="n">the</span> <span class="n">Reticle</span>
    <span class="n">IF</span> <span class="n">enumXPIM</span> <span class="o">=</span> <span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">Reticle</span> <span class="n">THEN</span>
        <span class="n">bLEDPower</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="o">//</span> <span class="n">Turn</span> <span class="n">off</span> <span class="n">the</span> <span class="n">LED</span> <span class="n">when</span> <span class="n">we</span> <span class="n">stop</span> <span class="n">at</span> <span class="nb">any</span> <span class="n">other</span> <span class="n">state</span>
    <span class="n">ELSIF</span> <span class="n">enumXPIM</span> <span class="o">&lt;&gt;</span> <span class="n">E_XPIM_States</span><span class="o">.</span><span class="n">Unknown</span> <span class="n">THEN</span>
        <span class="n">bLEDPower</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>
<span class="n">enumLastCycle</span> <span class="o">:=</span> <span class="n">enumXPIM</span><span class="p">;</span>

<span class="o">//</span> <span class="n">If</span> <span class="n">configured</span><span class="p">,</span> <span class="n">start</span> <span class="n">a</span> <span class="n">shutdown</span> <span class="n">timer</span> <span class="n">when</span> <span class="n">LED</span> <span class="n">goes</span> <span class="n">high</span>
<span class="n">IF</span> <span class="n">fLEDTimeOut</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="n">THEN</span><span class="p">;</span>
    <span class="n">tonLED</span><span class="p">(</span><span class="n">IN</span><span class="o">:=</span><span class="n">bLEDPower</span><span class="p">,</span>
           <span class="n">PT</span><span class="o">:=</span><span class="n">LREAL_TO_TIME</span><span class="p">(</span><span class="n">fLEDTimeOut</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>
    <span class="n">fLEDRemaining</span> <span class="o">:=</span> <span class="n">fLEDTimeOut</span> <span class="o">-</span> <span class="n">TIME_TO_LREAL</span><span class="p">(</span><span class="n">tonLED</span><span class="o">.</span><span class="n">ET</span><span class="p">)</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>

    <span class="n">IF</span> <span class="n">tonLED</span><span class="o">.</span><span class="n">Q</span> <span class="n">THEN</span>
        <span class="n">bLEDPower</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
    <span class="n">END_IF</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-xpim-states">E_XPIM_States</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xpim-opal">
<h2>FB_XPIM_Opal<a class="headerlink" href="#fb-xpim-opal" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XPIM_Opal</span>
<span class="n">VAR_INPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">PWR</span>
        <span class="n">io</span><span class="p">:</span> <span class="n">io</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">OFF</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">ON</span>
    <span class="s1">&#39;}</span>
    <span class="n">bOpalPower</span> <span class="n">AT</span> <span class="o">%</span><span class="n">Q</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="n">VAR</span>
    <span class="n">bOpalInit</span><span class="p">:</span> <span class="n">BOOL</span> <span class="o">:=</span> <span class="n">FALSE</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Turn</span> <span class="n">the</span> <span class="n">Opal</span> <span class="n">on</span> <span class="n">by</span> <span class="n">default</span>
<span class="n">IF</span> <span class="n">NOT</span> <span class="n">bOpalInit</span> <span class="n">THEN</span>
    <span class="n">bOpalPower</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
    <span class="n">bOpalInit</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">;</span>
<span class="n">END_IF</span>

<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="fb-xpimtest">
<h2>FB_XPIMTest<a class="headerlink" href="#fb-xpimtest" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>FUNCTION_BLOCK FB_XPIMTest EXTENDS FB_TestSuite
VAR
    fbXPIM: FB_XPIM;
    stYStage: ST_MotionStage;
    stZoomStage: ST_MotionStage;
    stFocusStage: ST_MotionStage;

    stEl6In: EL6inData22b;
    stEl6Out: EL6OutData22b;

    stDefault: ST_PositionState := (
        fVelocity:=10,
        bMoveOk:=TRUE,
        bValid:=TRUE
    );
    fbSetup: FB_StateSetupHelper;

    fbFFHWO: FB_HardwareFFOutput;
    fbArbiter: FB_Arbiter(1);
    fbSubSysIO: FB_DummyArbIO;

    bInit: BOOL;
END_VAR
// Fake PMPS handling
fbSubSysIO(
    LA:=fbArbiter,
    FFO:=fbFFHWO,
);

// Fake limit handling
stYStage.bLimitBackwardEnable := TRUE;
stYStage.bLimitForwardEnable := TRUE;

// Standard state setup
fbSetup(stPositionState:=stDefault, bSetDefault:=TRUE);
fbSetup(stPositionState:=fbXPIM.stOut, sName:=&#39;OUT&#39;, fPosition:=10, sPmpsState:=&#39;T0&#39;);
fbSetup(stPositionState:=fbXPIM.stReticle, sName:=&#39;T1&#39;, fPosition:=20, sPmpsState:=&#39;T1&#39;);
fbSetup(stPositionState:=fbXPIM.stYag, sName:=&#39;T2&#39;, fPosition:=30, sPmpsState:=&#39;T2&#39;);
fbSetup(stPositionState:=fbXPIM.stDiamond, sName:=&#39;T3&#39;, fPosition:=40, sPmpsState:=&#39;T3&#39;);

// Standard FB call
fbXPIM(
    stYStage:=stYStage,
    stZoomStage:=stZoomStage,
    stFocusStage:=stFocusStage,
    fbFFHWO:=fbFFHWO,
    fbArbiter:=fbArbiter,
    stEl6In:=stEl6In,
    stEl6Out:=stEl6Out,
    bEnableMotion:=TRUE,
    bEnableBeamParams:=TRUE,
    bEnablePositionLimits:=TRUE,
    sDeviceName:=&#39;DEVICE&#39;,
    sTransitionKey:=&#39;T9&#39;,
    bReadDBNow:=NOT bInit,
);

TestStateMove();

bInit := TRUE;

END_FUNCTION_BLOCK

METHOD TestStateMove
VAR_INST
    tonTimer: TON;
    nIterState: UINT := 0;
END_VAR
VAR CONSTANT
    nLastState: UINT := E_XPIM_States.RETICLE;
END_VAR
// Sanity check: can we at least move to every named state?
TEST(&#39;TestXPIMStateMove&#39;);

// Prepare a timeout
tonTimer(IN:=TRUE, PT:=T#10s);

// Start in Unknown, then go through the state positions one by one
IF fbXPIM.eEnumGet = nIterState THEN
    nIterState := nIterState + 1;
    fbXPIM.eEnumSet := nIterState;
END_IF

IF tonTimer.Q OR nIterState &gt; nLastState THEN
    AssertFalse(tonTimer.Q, &#39;Timeout in XPIM move test&#39;);
    TEST_FINISHED();
END_IF
END_METHOD
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#e-xpim-states">E_XPIM_States</a></p></li>
<li><p><a class="reference internal" href="#fb-xpim">FB_XPIM</a></p></li>
</ul>
</dd>
</dl>
</section>
<section id="fb-xtes-flowswitch">
<h2>FB_XTES_Flowswitch<a class="headerlink" href="#fb-xtes-flowswitch" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;analysis&#39;</span> <span class="o">:=</span> <span class="s1">&#39;-33&#39;</span><span class="p">}</span>
<span class="n">FUNCTION_BLOCK</span> <span class="n">FB_XTES_Flowswitch</span>
<span class="n">VAR_OUTPUT</span>
    <span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;pytmc&#39;</span> <span class="o">:=</span> <span class="s1">&#39;</span>
        <span class="n">pv</span><span class="p">:</span> <span class="n">FLOW_OK</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ZNAM</span> <span class="n">LOW</span>
        <span class="n">field</span><span class="p">:</span> <span class="n">ONAM</span> <span class="n">OK</span>
    <span class="s1">&#39;}</span>
    <span class="n">bFlowOk</span> <span class="n">AT</span> <span class="o">%</span><span class="n">I</span><span class="o">*</span><span class="p">:</span> <span class="n">BOOL</span><span class="p">;</span>
<span class="n">END_VAR</span>


<span class="n">END_FUNCTION_BLOCK</span>
</pre></div>
</div>
</section>
<section id="prg-test">
<h2>PRG_TEST<a class="headerlink" href="#prg-test" title="Link to this heading"></a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">attribute</span> <span class="s1">&#39;analysis&#39;</span> <span class="o">:=</span> <span class="s1">&#39;-33&#39;</span><span class="p">}</span>
<span class="n">PROGRAM</span> <span class="n">PRG_TEST</span>
<span class="n">VAR</span>
    <span class="n">fbATMTest</span><span class="p">:</span> <span class="n">FB_ATMTest</span><span class="p">;</span>
    <span class="n">fbLICTest</span><span class="p">:</span> <span class="n">FB_LICTest</span><span class="p">;</span>
    <span class="n">fbPPMTest</span><span class="p">:</span> <span class="n">FB_PPMTest</span><span class="p">;</span>
    <span class="n">fbREFTest</span><span class="p">:</span> <span class="n">FB_REFTest</span><span class="p">;</span>
    <span class="n">fbSATTTest</span><span class="p">:</span> <span class="n">FB_SATTTest</span><span class="p">;</span>
    <span class="n">fbSlitsPowerTest</span><span class="p">:</span> <span class="n">FB_SLITS_POWERTest</span><span class="p">;</span>
    <span class="n">fbWFSTest</span><span class="p">:</span> <span class="n">FB_WFSTest</span><span class="p">;</span>
    <span class="n">fbXPIMTest</span><span class="p">:</span> <span class="n">FB_XPIMTest</span><span class="p">;</span>
    <span class="n">fbCheckPositionStateWriteTest</span><span class="p">:</span> <span class="n">FB_CheckPositionStateWriteTest</span><span class="p">;</span>
    <span class="n">fbCCTempSensorTest</span><span class="p">:</span> <span class="n">FB_CC_TempSensorTest</span><span class="p">;</span>

    <span class="n">fbSetupJson</span><span class="p">:</span> <span class="n">FB_PMPSJsonTestHelper</span><span class="p">;</span>
    <span class="n">astBeamParams</span><span class="p">:</span> <span class="n">ARRAY</span><span class="p">[</span><span class="mf">0..9</span><span class="p">]</span> <span class="n">OF</span> <span class="n">ST_DbStateParams</span><span class="p">;</span>
    <span class="n">nIter</span><span class="p">:</span> <span class="n">UINT</span><span class="p">;</span>
<span class="n">END_VAR</span>
<span class="o">//</span> <span class="n">Setup</span> <span class="n">a</span> <span class="n">fake</span> <span class="n">db</span> <span class="n">export</span> <span class="k">for</span> <span class="n">the</span> <span class="n">test</span> <span class="n">suite</span>
<span class="n">FOR</span> <span class="n">nIter</span> <span class="o">:=</span> <span class="mi">0</span> <span class="n">TO</span> <span class="mi">9</span> <span class="n">DO</span>
    <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stBeamParams</span> <span class="o">:=</span> <span class="n">PMPS_GVL</span><span class="o">.</span><span class="n">cstFullBeam</span><span class="p">;</span>
    <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">sPmpsState</span> <span class="o">:=</span> <span class="n">CONCAT</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">,</span> <span class="n">UINT_TO_STRING</span><span class="p">(</span><span class="n">nIter</span><span class="p">));</span>
    <span class="n">astBeamParams</span><span class="p">[</span><span class="n">nIter</span><span class="p">]</span><span class="o">.</span><span class="n">stReactiveParams</span><span class="o">.</span><span class="n">nTempSP</span> <span class="o">:=</span> <span class="n">nIter</span> <span class="o">+</span> <span class="mi">20</span><span class="p">;</span>
<span class="n">END_FOR</span>
<span class="n">fbSetupJson</span><span class="p">(</span>
    <span class="n">astBeamParams</span> <span class="o">:=</span> <span class="n">astBeamParams</span><span class="p">,</span>
    <span class="n">bExecute</span> <span class="o">:=</span> <span class="n">TRUE</span><span class="p">,</span>
    <span class="n">sDevNAme</span> <span class="o">:=</span> <span class="s1">&#39;DEVICE&#39;</span><span class="p">,</span>
<span class="p">);</span>
<span class="o">//</span> <span class="n">Run</span> <span class="n">the</span> <span class="n">tests</span>
<span class="n">TcUnit</span><span class="o">.</span><span class="n">RUN</span><span class="p">();</span>

<span class="n">END_PROGRAM</span>
</pre></div>
</div>
<dl class="simple">
<dt>Related:</dt><dd><ul class="simple">
<li><p><a class="reference internal" href="#fb-atmtest">FB_ATMTest</a></p></li>
<li><p><a class="reference internal" href="#fb-cc-tempsensortest">FB_CC_TempSensorTest</a></p></li>
<li><p><a class="reference internal" href="#fb-checkpositionstatewritetest">FB_CheckPositionStateWriteTest</a></p></li>
<li><p><a class="reference internal" href="#fb-lictest">FB_LICTest</a></p></li>
<li><p><a class="reference internal" href="#fb-pmpsjsontesthelper">FB_PMPSJsonTestHelper</a></p></li>
<li><p><a class="reference internal" href="#fb-ppmtest">FB_PPMTest</a></p></li>
<li><p><a class="reference internal" href="#fb-reftest">FB_REFTest</a></p></li>
<li><p><a class="reference internal" href="#fb-satttest">FB_SATTTest</a></p></li>
<li><p><a class="reference internal" href="#fb-slits-powertest">FB_SLITS_POWERTest</a></p></li>
<li><p><a class="reference internal" href="#fb-wfstest">FB_WFSTest</a></p></li>
<li><p><a class="reference internal" href="#fb-xpimtest">FB_XPIMTest</a></p></li>
</ul>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lcls-twincat-common-components_Library_epics.html" class="btn btn-neutral float-left" title="Data Types" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, SLAC National Accelerator Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>